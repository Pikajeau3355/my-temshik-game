<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>City Holder üèôÔ∏è</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800;900&display=swap');
        
        * {
            font-family: 'Poppins', sans-serif;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #0a0e27;
            background-image: 
                radial-gradient(ellipse at top, rgba(20, 40, 100, 0.4) 0%, transparent 50%),
                radial-gradient(ellipse at bottom, rgba(10, 20, 60, 0.3) 0%, transparent 50%);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                repeating-linear-gradient(0deg, rgba(255,255,255,0.03) 0px, transparent 1px, transparent 2px, rgba(255,255,255,0.03) 3px),
                repeating-linear-gradient(90deg, rgba(255,255,255,0.03) 0px, transparent 1px, transparent 2px, rgba(255,255,255,0.03) 3px);
            pointer-events: none;
            z-index: 1;
        }
        
        .tap-button {
            background: linear-gradient(145deg, #ffeb3b 0%, #ffc107 50%, #ff9800 100%);
            box-shadow: 
                0 20px 40px rgba(255, 193, 7, 0.4),
                0 10px 20px rgba(255, 152, 0, 0.3),
                inset 0 -8px 16px rgba(0, 0, 0, 0.2),
                inset 0 8px 16px rgba(255, 255, 255, 0.3);
            border: 4px solid rgba(255, 235, 59, 0.5);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
            position: relative;
        }
        
        .tap-button::before {
            content: '';
            position: absolute;
            inset: -4px;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .tap-button:active::before {
            opacity: 1;
        }
        
        .tap-button:active {
            transform: translateY(8px) translateZ(-20px) scale(0.95);
            box-shadow: 
                0 8px 20px rgba(255, 193, 7, 0.3),
                0 4px 10px rgba(255, 152, 0, 0.2),
                inset 0 -4px 8px rgba(0, 0, 0, 0.3),
                inset 0 4px 8px rgba(255, 255, 255, 0.2);
        }
        
        .tap-button.disabled {
            background: linear-gradient(145deg, #424242, #212121);
            box-shadow: 
                0 10px 20px rgba(0, 0, 0, 0.4),
                inset 0 -4px 8px rgba(0, 0, 0, 0.3);
            border-color: rgba(66, 66, 66, 0.5);
        }
        
        .building-card {
            background: linear-gradient(135deg, #1a237e 0%, #283593 50%, #1a237e 100%);
            border: 2px solid rgba(63, 81, 181, 0.4);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
            position: relative;
            box-shadow: 
                0 10px 30px rgba(0, 0, 0, 0.5),
                0 1px 0 rgba(255, 255, 255, 0.1) inset,
                0 -1px 0 rgba(0, 0, 0, 0.5) inset;
        }
        
        .building-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            border-radius: inherit;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .building-card:active {
            transform: translateZ(-10px) scale(0.98);
        }
        
        .building-card:active::before {
            opacity: 1;
        }
        
        .building-card.locked {
            opacity: 0.4;
            filter: grayscale(1);
            transform: scale(0.95);
        }
        
        .coin-animation {
            position: fixed;
            pointer-events: none;
            font-size: 24px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            animation: coinFloat 1s ease-out forwards;
            z-index: 1000;
        }
        
        @keyframes coinFloat {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-80px) scale(1.5); }
        }
        
        .energy-bar {
            background: linear-gradient(90deg, #00d4ff, #0099cc);
            transition: width 0.3s ease;
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .city-bg {
            background: linear-gradient(180deg, transparent 0%, rgba(15, 52, 96, 0.8) 100%);
        }
        
        .tab-active {
            background: linear-gradient(145deg, #ffd700, #ffaa00);
            color: #1a1a2e;
        }
        
        .mission-card {
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            border-left: 4px solid #ffd700;
            position: relative;
            transform-style: preserve-3d;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 8px 20px rgba(0, 0, 0, 0.4),
                0 2px 0 rgba(255, 215, 0, 0.3) inset;
        }
        
        .mission-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #ffd700, #ffaa00);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        
        .mission-card:active {
            transform: translateX(4px) translateZ(-5px);
        }
        
        .mission-card.completed {
            border-left-color: #00ff88;
            opacity: 0.6;
            background: linear-gradient(135deg, #1a3a1a 0%, #2d4a2d 100%);
        }
        
        .mission-card.completed::before {
            background: linear-gradient(180deg, #00ff88, #00cc66);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }
        
        .booster-active {
            animation: glow 1s infinite alternate;
        }
        
        @keyframes glow {
            from { box-shadow: 0 0 10px #ffd700; }
            to { box-shadow: 0 0 25px #ffd700, 0 0 40px #ffaa00; }
        }
        
        .notification {
            animation: slideIn 0.3s ease, slideOut 0.3s ease 2.7s forwards;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateY(0); opacity: 1; }
            to { transform: translateY(-100%); opacity: 0; }
        }
        
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
        }
        
        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite;
            box-shadow: 0 0 4px rgba(255, 255, 255, 0.8);
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.5); }
        }
        
        /* 3D Panel Styles */
        .panel-3d {
            background: linear-gradient(135deg, rgba(26, 35, 126, 0.9) 0%, rgba(40, 53, 147, 0.9) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(63, 81, 181, 0.3);
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.5),
                0 0 1px rgba(255, 255, 255, 0.2) inset,
                0 10px 40px rgba(63, 81, 181, 0.1);
            transform-style: preserve-3d;
            position: relative;
        }
        
        .panel-3d::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, transparent 100%);
            border-radius: inherit;
            pointer-events: none;
        }
        
        /* Isometric City */
        .isometric-city {
            perspective: 1000px;
            transform-style: preserve-3d;
        }
        
        .building-3d {
            transform-style: preserve-3d;
            transition: transform 0.3s ease;
            filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.5));
        }
        
        .building-3d:hover {
            transform: translateY(-10px) rotateX(5deg);
        }
        
        /* Button 3D Effects */
        .btn-3d {
            position: relative;
            transform-style: preserve-3d;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 10px 20px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset;
        }
        
        .btn-3d:active {
            transform: translateY(4px) translateZ(-10px);
            box-shadow: 
                0 5px 10px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset;
        }
        
        /* Stat Card 3D */
        .stat-card-3d {
            background: linear-gradient(135deg, rgba(30, 40, 80, 0.8) 0%, rgba(20, 30, 60, 0.8) 100%);
            border: 1px solid rgba(100, 120, 200, 0.3);
            box-shadow: 
                0 8px 20px rgba(0, 0, 0, 0.4),
                0 0 1px rgba(255, 255, 255, 0.1) inset;
            transform-style: preserve-3d;
            transition: transform 0.3s ease;
        }
        
        .stat-card-3d:active {
            transform: translateZ(-5px) scale(0.98);
        }
        
        /* Mobile Optimizations */
        @media (max-width: 640px) {
            .tap-button {
                width: 160px !important;
                height: 160px !important;
                font-size: 4rem !important;
            }
            
            .building-card {
                padding: 1rem !important;
            }
            
            body {
                font-size: 14px;
            }
        }
        
        @media (max-width: 375px) {
            .tap-button {
                width: 140px !important;
                height: 140px !important;
                font-size: 3.5rem !important;
            }
        }
    </style>
</head>
<body class="text-white">
    <!-- Stars Background -->
    <div class="stars" id="stars"></div>
    
    <!-- Notification Container -->
    <div id="notification" class="fixed top-4 left-4 right-4 z-50 hidden">
        <div class="bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl p-4 shadow-xl notification">
            <p id="notificationText" class="text-center font-semibold"></p>
        </div>
    </div>
    
    <!-- Header -->
    <header class="fixed top-0 left-0 right-0 z-40 backdrop-blur-xl p-4" style="background: linear-gradient(180deg, rgba(10, 14, 39, 0.95) 0%, rgba(10, 14, 39, 0.8) 80%, transparent 100%);">
        <div class="flex justify-between items-center max-w-lg mx-auto">
            <div class="flex items-center gap-3">
                <div class="text-3xl building-3d" style="filter: drop-shadow(0 4px 8px rgba(255, 215, 0, 0.3));">
                    üèôÔ∏è
                </div>
                <div>
                    <h1 class="font-bold text-xl" style="text-shadow: 0 2px 10px rgba(255, 215, 0, 0.3);">City Holder</h1>
                    <p class="text-xs text-gray-400" id="playerName">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div class="panel-3d rounded-full px-4 py-2 flex items-center gap-2">
                    <span class="text-xl">‚≠ê</span>
                    <span class="font-bold text-lg" id="cityLevel">1</span>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="pt-24 pb-32 px-4 max-w-lg mx-auto relative z-10">
        <!-- Resources Panel -->
        <div class="panel-3d rounded-3xl p-5 mb-6">
            <div class="grid grid-cols-2 gap-4">
                <div class="text-center stat-card-3d rounded-2xl p-4">
                    <p class="text-gray-300 text-sm mb-2 flex items-center justify-center gap-1">
                        <span class="text-xl">üí∞</span>
                        <span>–ú–æ–Ω–µ—Ç—ã</span>
                    </p>
                    <p class="text-3xl font-black text-yellow-400 mb-1" id="coins" style="text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);">0</p>
                    <p class="text-xs text-green-400 font-semibold" id="passiveIncome">+0/—Å–µ–∫</p>
                </div>
                <div class="text-center stat-card-3d rounded-2xl p-4">
                    <p class="text-gray-300 text-sm mb-2 flex items-center justify-center gap-1">
                        <span class="text-xl">‚ö°</span>
                        <span>–≠–Ω–µ—Ä–≥–∏—è</span>
                    </p>
                    <p class="text-3xl font-black text-cyan-400 mb-1" style="text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);">
                        <span id="energy">100</span>/<span id="maxEnergy">100</span>
                    </p>
                    <div class="w-full bg-slate-900/50 rounded-full h-3 mt-2 overflow-hidden" style="box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.5);">
                        <div class="energy-bar h-3 rounded-full" id="energyBar" style="width: 100%; background: linear-gradient(90deg, #00d4ff, #0099cc); box-shadow: 0 0 10px rgba(0, 212, 255, 0.6);"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab Navigation -->
        <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
            <button onclick="switchTab('city')" id="tab-city" class="tab-active px-4 py-2 rounded-full font-semibold whitespace-nowrap transition-all">
                üèôÔ∏è –ì–æ—Ä–æ–¥
            </button>
            <button onclick="switchTab('buildings')" id="tab-buildings" class="bg-slate-700/50 px-4 py-2 rounded-full font-semibold whitespace-nowrap transition-all">
                üèóÔ∏è –ó–¥–∞–Ω–∏—è
            </button>
            <button onclick="switchTab('missions')" id="tab-missions" class="bg-slate-700/50 px-4 py-2 rounded-full font-semibold whitespace-nowrap transition-all relative">
                üìã –ó–∞–¥–∞–Ω–∏—è
                <span id="missionBadge" class="absolute -top-1 -right-1 bg-red-500 text-xs w-5 h-5 rounded-full flex items-center justify-center hidden">0</span>
            </button>
            <button onclick="switchTab('boosters')" id="tab-boosters" class="bg-slate-700/50 px-4 py-2 rounded-full font-semibold whitespace-nowrap transition-all">
                üöÄ –ë—É—Å—Ç–µ—Ä—ã
            </button>
        </div>
        
        <!-- City Tab -->
        <div id="cityTab" class="tab-content">
            <!-- City Visualization -->
            <div class="relative panel-3d rounded-3xl p-6 mb-6 min-h-[240px] overflow-hidden isometric-city" style="background: linear-gradient(180deg, rgba(15, 30, 80, 0.9) 0%, rgba(10, 20, 50, 0.9) 100%);">
                <div class="absolute inset-0" style="background: radial-gradient(ellipse at center, rgba(100, 150, 255, 0.1) 0%, transparent 70%);"></div>
                
                <!-- Sky gradient -->
                <div class="absolute top-0 left-0 right-0 h-32" style="background: linear-gradient(180deg, rgba(100, 150, 255, 0.2) 0%, transparent 100%);"></div>
                
                <div id="cityView" class="relative z-10 flex justify-center items-end gap-3 h-48" style="perspective: 800px; transform-style: preserve-3d;">
                    <!-- Buildings will be rendered here -->
                </div>
                
                <!-- Ground with 3D effect -->
                <div class="absolute bottom-0 left-0 right-0 h-12" style="background: linear-gradient(180deg, transparent 0%, rgba(34, 139, 34, 0.6) 30%, rgba(34, 100, 34, 0.8) 100%); box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.5);"></div>
                
                <!-- Grid lines for depth -->
                <div class="absolute bottom-12 left-0 right-0" style="height: 2px; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);"></div>
            </div>
            
            <!-- Tap Area -->
            <div class="text-center mb-6">
                <p class="text-gray-300 mb-3 font-semibold text-lg" style="text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);">–¢–∞–ø–Ω–∏, —á—Ç–æ–±—ã –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å!</p>
                <p class="text-base text-yellow-400 mb-6 font-bold" id="tapBonus" style="text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);">+1 üí∞ –∑–∞ —Ç–∞–ø</p>
                
                <button id="tapButton" onclick="handleTap(event)" class="tap-button w-40 h-40 rounded-full flex items-center justify-center text-6xl mx-auto transition-transform" style="transform: translateZ(0);">
                    üèôÔ∏è
                </button>
                
                <div id="boosterStatus" class="mt-6 hidden">
                    <div class="inline-flex items-center gap-3 panel-3d px-6 py-3 rounded-full" style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.2) 0%, rgba(255, 152, 0, 0.2) 100%); border: 2px solid rgba(255, 193, 7, 0.4);">
                        <span class="text-2xl">üöÄ</span>
                        <span class="font-black text-yellow-400 text-xl">x<span id="boosterMultiplier">1</span></span>
                        <span class="text-sm text-gray-300 font-semibold">(<span id="boosterTime">0</span>—Å)</span>
                    </div>
                </div>
            </div>
            
            <!-- Quick Stats -->
            <div class="grid grid-cols-3 gap-3 text-center">
                <div class="bg-slate-800/50 rounded-xl p-3">
                    <p class="text-2xl mb-1">üëÜ</p>
                    <p class="text-sm text-gray-400">–¢–∞–ø–æ–≤</p>
                    <p class="font-bold" id="totalTaps">0</p>
                </div>
                <div class="bg-slate-800/50 rounded-xl p-3">
                    <p class="text-2xl mb-1">üè¢</p>
                    <p class="text-sm text-gray-400">–ó–¥–∞–Ω–∏–π</p>
                    <p class="font-bold" id="totalBuildings">0</p>
                </div>
                <div class="bg-slate-800/50 rounded-xl p-3">
                    <p class="text-2xl mb-1">üìà</p>
                    <p class="text-sm text-gray-400">–î–æ—Ö–æ–¥/—Ç–∞–ø</p>
                    <p class="font-bold text-yellow-400" id="incomePerTap">1</p>
                </div>
            </div>
        </div>
        
        <!-- Buildings Tab -->
        <div id="buildingsTab" class="tab-content hidden">
            <h2 class="text-xl font-bold mb-4">üèóÔ∏è –ó–¥–∞–Ω–∏—è –≥–æ—Ä–æ–¥–∞</h2>
            <div class="space-y-4" id="buildingsList">
                <!-- Buildings will be rendered here -->
            </div>
        </div>
        
        <!-- Missions Tab -->
        <div id="missionsTab" class="tab-content hidden">
            <h2 class="text-xl font-bold mb-4">üìã –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</h2>
            <div class="space-y-3" id="missionsList">
                <!-- Missions will be rendered here -->
            </div>
            
            <div class="mt-6 text-center">
                <p class="text-sm text-gray-400">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑: <span id="missionsTimer" class="text-cyan-400 font-bold">--:--:--</span></p>
            </div>
        </div>
        
        <!-- Boosters Tab -->
        <div id="boostersTab" class="tab-content hidden">
            <h2 class="text-xl font-bold mb-4">üöÄ –ë—É—Å—Ç–µ—Ä—ã</h2>
            <div class="space-y-4" id="boostersList">
                <!-- Boosters will be rendered here -->
            </div>
        </div>
    </main>
    
    <!-- Offline Earnings Modal -->
    <div id="offlineModal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 hidden">
        <div class="bg-gradient-to-b from-slate-800 to-slate-900 rounded-3xl p-6 max-w-sm w-full text-center">
            <div class="text-6xl mb-4">üí∞</div>
            <h2 class="text-2xl font-bold mb-2">–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º!</h2>
            <p class="text-gray-400 mb-4">–ü–æ–∫–∞ –≤–∞—Å –Ω–µ –±—ã–ª–æ, –≥–æ—Ä–æ–¥ –∑–∞—Ä–∞–±–æ—Ç–∞–ª:</p>
            <p class="text-4xl font-bold text-yellow-400 mb-6">+<span id="offlineEarnings">0</span> üí∞</p>
            <button onclick="claimOfflineEarnings()" class="w-full bg-gradient-to-r from-yellow-500 to-orange-500 py-3 rounded-xl font-bold text-lg">
                –ó–∞–±—Ä–∞—Ç—å!
            </button>
        </div>
    </div>

    <script>
        // ==================== GAME DATA ====================
        const BUILDINGS = [
            {
                id: 'house',
                name: '–ñ–∏–ª–æ–π –¥–æ–º',
                icon: 'üè†',
                description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –ø–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥',
                baseCost: 50,
                baseBonus: 1,
                bonusType: 'passive',
                unlockLevel: 1
            },
            {
                id: 'business',
                name: '–ë–∏–∑–Ω–µ—Å-—Ü–µ–Ω—Ç—Ä',
                icon: 'üè¢',
                description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –¥–æ—Ö–æ–¥ —Å —Ç–∞–ø–æ–≤',
                baseCost: 200,
                baseBonus: 1,
                bonusType: 'tap',
                unlockLevel: 1
            },
            {
                id: 'factory',
                name: '–ó–∞–≤–æ–¥',
                icon: 'üè≠',
                description: '–î–∞—ë—Ç –±–æ–Ω—É—Å –∫ –ø–∞—Å—Å–∏–≤–Ω–æ–º—É –¥–æ—Ö–æ–¥—É',
                baseCost: 500,
                baseBonus: 5,
                bonusType: 'passive',
                unlockLevel: 2
            },
            {
                id: 'townhall',
                name: '–ú—ç—Ä–∏—è',
                icon: 'üèõÔ∏è',
                description: '–ü–æ–≤—ã—à–∞–µ—Ç —É—Ä–æ–≤–µ–Ω—å –≥–æ—Ä–æ–¥–∞',
                baseCost: 1000,
                baseBonus: 1,
                bonusType: 'level',
                unlockLevel: 3
            },
            {
                id: 'park',
                name: '–ü–∞—Ä–∫',
                icon: 'üå≥',
                description: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –º–∞–∫—Å–∏–º—É–º —ç–Ω–µ—Ä–≥–∏–∏',
                baseCost: 300,
                baseBonus: 10,
                bonusType: 'energy',
                unlockLevel: 2
            },
            {
                id: 'powerplant',
                name: '–≠–ª–µ–∫—Ç—Ä–æ—Å—Ç–∞–Ω—Ü–∏—è',
                icon: '‚ö°',
                description: '–£—Å–∫–æ—Ä—è–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–Ω–µ—Ä–≥–∏–∏',
                baseCost: 800,
                baseBonus: 0.5,
                bonusType: 'energyRegen',
                unlockLevel: 4
            }
        ];

        const MISSIONS = [
            { id: 'tap100', name: '–¢–∞–ø–Ω–∏ 100 —Ä–∞–∑', target: 100, type: 'taps', reward: 500, icon: 'üëÜ' },
            { id: 'tap500', name: '–¢–∞–ø–Ω–∏ 500 —Ä–∞–∑', target: 500, type: 'taps', reward: 2500, icon: 'üëÜ' },
            { id: 'earn1000', name: '–ó–∞—Ä–∞–±–æ—Ç–∞–π 1000 –º–æ–Ω–µ—Ç', target: 1000, type: 'earnings', reward: 300, icon: 'üí∞' },
            { id: 'earn5000', name: '–ó–∞—Ä–∞–±–æ—Ç–∞–π 5000 –º–æ–Ω–µ—Ç', target: 5000, type: 'earnings', reward: 1500, icon: 'üí∞' },
            { id: 'upgrade3', name: '–£–ª—É—á—à–∏ –∑–¥–∞–Ω–∏—è 3 —Ä–∞–∑–∞', target: 3, type: 'upgrades', reward: 800, icon: 'üèóÔ∏è' },
            { id: 'useBooster', name: '–ò—Å–ø–æ–ª—å–∑—É–π –±—É—Å—Ç–µ—Ä', target: 1, type: 'boosters', reward: 200, icon: 'üöÄ' }
        ];

        const BOOSTERS = [
            { id: 'x2', name: '–î–≤–æ–π–Ω–æ–π –¥–æ—Ö–æ–¥', icon: '‚ö°', multiplier: 2, duration: 30, cost: 100 },
            { id: 'x5', name: '–ü—è—Ç–∏–∫—Ä–∞—Ç–Ω—ã–π –¥–æ—Ö–æ–¥', icon: 'üî•', multiplier: 5, duration: 15, cost: 300 },
            { id: 'energy', name: '–ü–æ–ª–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è', icon: 'üîã', type: 'energy', cost: 150 },
            { id: 'x10', name: '–ú–µ–≥–∞ –±—É—Å—Ç–µ—Ä', icon: 'üíé', multiplier: 10, duration: 10, cost: 500 }
        ];

        // ==================== GAME STATE ====================
        let gameState = {
            coins: 0,
            energy: 100,
            maxEnergy: 100,
            cityLevel: 1,
            totalTaps: 0,
            todayTaps: 0,
            todayEarnings: 0,
            todayUpgrades: 0,
            todayBoosters: 0,
            buildings: {},
            completedMissions: [],
            lastOnline: Date.now(),
            lastMissionReset: Date.now(),
            energyRegen: 1,
            activeBooster: null,
            boosterEndTime: 0
        };

        // ==================== TELEGRAM INTEGRATION ====================
        let tg = window.Telegram?.WebApp;
        
        function initTelegram() {
            if (tg) {
                tg.ready();
                tg.expand();
                
                const user = tg.initDataUnsafe?.user;
                if (user) {
                    document.getElementById('playerName').textContent = user.first_name || '–ò–≥—Ä–æ–∫';
                } else {
                    document.getElementById('playerName').textContent = '–ì–æ—Å—Ç—å';
                }
                
                // Set theme
                if (tg.colorScheme === 'light') {
                    document.body.style.background = 'linear-gradient(180deg, #e8f4f8 0%, #b8d4e3 50%, #87ceeb 100%)';
                }
            } else {
                document.getElementById('playerName').textContent = '–î–µ–º–æ —Ä–µ–∂–∏–º';
            }
        }

        // ==================== SAVE/LOAD ====================
        function saveGame() {
            gameState.lastOnline = Date.now();
            localStorage.setItem('cityHolder', JSON.stringify(gameState));
        }

        function loadGame() {
            const saved = localStorage.getItem('cityHolder');
            if (saved) {
                const parsed = JSON.parse(saved);
                gameState = { ...gameState, ...parsed };
                
                // Calculate offline earnings
                const offlineTime = (Date.now() - gameState.lastOnline) / 1000;
                const passiveIncome = calculatePassiveIncome();
                const offlineEarnings = Math.floor(offlineTime * passiveIncome * 0.5); // 50% efficiency offline
                
                if (offlineEarnings > 10) {
                    document.getElementById('offlineEarnings').textContent = formatNumber(offlineEarnings);
                    document.getElementById('offlineModal').classList.remove('hidden');
                    gameState.pendingOfflineEarnings = offlineEarnings;
                }
                
                // Check mission reset
                checkMissionReset();
            }
        }

        function claimOfflineEarnings() {
            if (gameState.pendingOfflineEarnings) {
                gameState.coins += gameState.pendingOfflineEarnings;
                gameState.pendingOfflineEarnings = 0;
            }
            document.getElementById('offlineModal').classList.add('hidden');
            updateUI();
            saveGame();
        }

        // ==================== CORE MECHANICS ====================
        function handleTap(event) {
            if (gameState.energy <= 0) {
                showNotification('‚ö° –ù–µ—Ç —ç–Ω–µ—Ä–≥–∏–∏! –ü–æ–¥–æ–∂–¥–∏—Ç–µ...', 'warning');
                return;
            }
            
            // Calculate earnings
            let earnings = calculateTapIncome();
            
            // Apply booster
            if (gameState.activeBooster && Date.now() < gameState.boosterEndTime) {
                earnings *= gameState.activeBooster.multiplier;
            }
            
            // Update state
            gameState.coins += earnings;
            gameState.energy -= 1;
            gameState.totalTaps += 1;
            gameState.todayTaps += 1;
            gameState.todayEarnings += earnings;
            
            // Show floating coin
            createCoinAnimation(event.clientX || event.touches?.[0]?.clientX || window.innerWidth/2, 
                               event.clientY || event.touches?.[0]?.clientY || window.innerHeight/2, 
                               earnings);
            
            // Haptic feedback
            if (tg?.HapticFeedback) {
                tg.HapticFeedback.impactOccurred('light');
            }
            
            updateUI();
            checkMissions();
            saveGame();
        }

        function createCoinAnimation(x, y, amount) {
            const coin = document.createElement('div');
            coin.className = 'coin-animation';
            coin.textContent = `+${formatNumber(amount)}`;
            coin.style.left = `${x}px`;
            coin.style.top = `${y}px`;
            document.body.appendChild(coin);
            
            setTimeout(() => coin.remove(), 1000);
        }

        function calculateTapIncome() {
            let base = 1;
            
            // Add business center bonus
            const businessLevel = gameState.buildings['business'] || 0;
            base += businessLevel * BUILDINGS.find(b => b.id === 'business').baseBonus;
            
            // City level bonus
            base += Math.floor(gameState.cityLevel * 0.5);
            
            return base;
        }

        function calculatePassiveIncome() {
            let income = 0;
            
            // House income
            const houseLevel = gameState.buildings['house'] || 0;
            income += houseLevel * BUILDINGS.find(b => b.id === 'house').baseBonus;
            
            // Factory income
            const factoryLevel = gameState.buildings['factory'] || 0;
            income += factoryLevel * BUILDINGS.find(b => b.id === 'factory').baseBonus;
            
            return income;
        }

        function calculateCityLevel() {
            const townhallLevel = gameState.buildings['townhall'] || 0;
            let baseLevel = 1 + townhallLevel;
            
            // Bonus from total buildings
            const totalBuildingLevels = Object.values(gameState.buildings).reduce((a, b) => a + b, 0);
            baseLevel += Math.floor(totalBuildingLevels / 10);
            
            return baseLevel;
        }

        // ==================== BUILDINGS ====================
        function upgradeBuilding(buildingId) {
            const building = BUILDINGS.find(b => b.id === buildingId);
            if (!building) return;
            
            const currentLevel = gameState.buildings[buildingId] || 0;
            const cost = calculateBuildingCost(building, currentLevel);
            
            if (gameState.cityLevel < building.unlockLevel) {
                showNotification(`üîí –¢—Ä–µ–±—É–µ—Ç—Å—è —É—Ä–æ–≤–µ–Ω—å –≥–æ—Ä–æ–¥–∞ ${building.unlockLevel}`, 'error');
                return;
            }
            
            if (gameState.coins < cost) {
                showNotification('üí∞ –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!', 'error');
                return;
            }
            
            gameState.coins -= cost;
            gameState.buildings[buildingId] = currentLevel + 1;
            gameState.todayUpgrades += 1;
            
            // Apply special effects
            if (building.bonusType === 'energy') {
                gameState.maxEnergy += building.baseBonus;
            } else if (building.bonusType === 'energyRegen') {
                gameState.energyRegen += building.baseBonus;
            }
            
            // Update city level
            gameState.cityLevel = calculateCityLevel();
            
            showNotification(`üèóÔ∏è ${building.name} —É–ª—É—á—à–µ–Ω –¥–æ —É—Ä–æ–≤–Ω—è ${currentLevel + 1}!`, 'success');
            
            if (tg?.HapticFeedback) {
                tg.HapticFeedback.notificationOccurred('success');
            }
            
            updateUI();
            renderBuildings();
            renderCityView();
            checkMissions();
            saveGame();
        }

        function calculateBuildingCost(building, level) {
            return Math.floor(building.baseCost * Math.pow(1.5, level));
        }

        function renderBuildings() {
            const container = document.getElementById('buildingsList');
            container.innerHTML = '';
            
            BUILDINGS.forEach(building => {
                const level = gameState.buildings[building.id] || 0;
                const cost = calculateBuildingCost(building, level);
                const isLocked = gameState.cityLevel < building.unlockLevel;
                const canAfford = gameState.coins >= cost;
                
                const bonus = building.bonusType === 'passive' ? `+${level * building.baseBonus}/—Å–µ–∫` :
                              building.bonusType === 'tap' ? `+${level * building.baseBonus}/—Ç–∞–ø` :
                              building.bonusType === 'energy' ? `+${level * building.baseBonus} –º–∞–∫—Å. —ç–Ω–µ—Ä–≥–∏–∏` :
                              building.bonusType === 'energyRegen' ? `+${(level * building.baseBonus).toFixed(1)}/—Å–µ–∫ –≤–æ—Å—Å—Ç.` :
                              `–£—Ä–æ–≤–µ–Ω—å +${level * building.baseBonus}`;
                
                container.innerHTML += `
                    <div class="building-card rounded-2xl p-4 ${isLocked ? 'locked' : ''}">
                        <div class="flex items-center gap-4">
                            <div class="text-4xl">${building.icon}</div>
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <h3 class="font-bold">${building.name}</h3>
                                    <span class="bg-slate-700 px-2 py-0.5 rounded text-sm">Lv.${level}</span>
                                </div>
                                <p class="text-sm text-gray-400">${building.description}</p>
                                <p class="text-sm text-yellow-400">${bonus}</p>
                            </div>
                            <div class="text-right">
                                ${isLocked ? 
                                    `<p class="text-sm text-gray-500">üîí –£—Ä. ${building.unlockLevel}</p>` :
                                    `<button onclick="upgradeBuilding('${building.id}')" 
                                        class="px-4 py-2 rounded-xl font-bold transition-all ${canAfford ? 
                                            'bg-gradient-to-r from-yellow-500 to-orange-500 hover:scale-105' : 
                                            'bg-gray-600 cursor-not-allowed'}">
                                        ${formatNumber(cost)} üí∞
                                    </button>`
                                }
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        function renderCityView() {
            const container = document.getElementById('cityView');
            container.innerHTML = '';
            
            const buildingHeights = {
                'house': 50,
                'business': 80,
                'factory': 65,
                'townhall': 100,
                'park': 35,
                'powerplant': 70
            };
            
            const buildingColors = {
                'house': 'linear-gradient(135deg, #ef5350 0%, #c62828 100%)',
                'business': 'linear-gradient(135deg, #42a5f5 0%, #1976d2 100%)',
                'factory': 'linear-gradient(135deg, #9e9e9e 0%, #616161 100%)',
                'townhall': 'linear-gradient(135deg, #ffd54f 0%, #f9a825 100%)',
                'park': 'linear-gradient(135deg, #66bb6a 0%, #388e3c 100%)',
                'powerplant': 'linear-gradient(135deg, #ffb74d 0%, #f57c00 100%)'
            };
            
            BUILDINGS.forEach(building => {
                const level = gameState.buildings[building.id] || 0;
                if (level > 0) {
                    const height = buildingHeights[building.id] + (level * 8);
                    const color = buildingColors[building.id];
                    
                    container.innerHTML += `
                        <div class="building-3d flex flex-col items-center justify-end gap-1" style="height: ${height}px; min-width: 60px;">
                            <!-- Building body with 3D effect -->
                            <div class="relative flex flex-col items-center justify-end" style="height: ${height - 20}px; width: 50px;">
                                <!-- Main building -->
                                <div class="w-full rounded-t-lg relative overflow-hidden" 
                                     style="height: 100%; 
                                            background: ${color};
                                            box-shadow: 
                                                0 10px 30px rgba(0, 0, 0, 0.6),
                                                inset -4px 0 8px rgba(0, 0, 0, 0.3),
                                                inset 4px 0 8px rgba(255, 255, 255, 0.2);
                                            border: 2px solid rgba(255, 255, 255, 0.2);
                                            transform: perspective(500px) rotateY(-5deg);">
                                    
                                    <!-- Windows/details -->
                                    <div class="absolute inset-0 grid grid-cols-2 gap-1 p-2">
                                        ${Array(Math.min(level * 2, 8)).fill(0).map((_, i) => `
                                            <div class="bg-yellow-300/60 rounded-sm" 
                                                 style="box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.3), 0 0 4px rgba(255, 255, 100, 0.4);"></div>
                                        `).join('')}
                                    </div>
                                    
                                    <!-- Roof shine -->
                                    <div class="absolute top-0 left-0 right-0 h-1/3" 
                                         style="background: linear-gradient(180deg, rgba(255, 255, 255, 0.3) 0%, transparent 100%);"></div>
                                </div>
                                
                                <!-- Icon on top -->
                                <div class="absolute -top-6 text-3xl" 
                                     style="filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.5));">
                                    ${building.icon}
                                </div>
                            </div>
                            
                            <!-- Level badge -->
                            <div class="panel-3d px-2 py-1 rounded-lg text-xs font-bold" 
                                 style="background: rgba(0, 0, 0, 0.6); 
                                        border: 1px solid rgba(255, 255, 255, 0.2);
                                        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);">
                                –£—Ä.${level}
                            </div>
                        </div>
                    `;
                }
            });
            
            if (container.innerHTML === '') {
                container.innerHTML = `
                    <div class="text-center w-full" style="transform: translateY(50%);">
                        <p class="text-gray-400 text-lg mb-2">üèóÔ∏è</p>
                        <p class="text-gray-500 font-semibold">–ü–æ—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–≤–æ–µ –∑–¥–∞–Ω–∏–µ!</p>
                    </div>
                `;
            }
        }

        // ==================== MISSIONS ====================
        function checkMissionReset() {
            const now = new Date();
            const lastReset = new Date(gameState.lastMissionReset);
            
            if (now.getDate() !== lastReset.getDate() || 
                now.getMonth() !== lastReset.getMonth() ||
                now.getFullYear() !== lastReset.getFullYear()) {
                // Reset daily stats
                gameState.todayTaps = 0;
                gameState.todayEarnings = 0;
                gameState.todayUpgrades = 0;
                gameState.todayBoosters = 0;
                gameState.completedMissions = [];
                gameState.lastMissionReset = Date.now();
            }
        }

        function checkMissions() {
            let completed = 0;
            
            MISSIONS.forEach(mission => {
                if (gameState.completedMissions.includes(mission.id)) return;
                
                let progress = 0;
                switch (mission.type) {
                    case 'taps': progress = gameState.todayTaps; break;
                    case 'earnings': progress = gameState.todayEarnings; break;
                    case 'upgrades': progress = gameState.todayUpgrades; break;
                    case 'boosters': progress = gameState.todayBoosters; break;
                }
                
                if (progress >= mission.target) {
                    completed++;
                }
            });
            
            const badge = document.getElementById('missionBadge');
            if (completed > 0) {
                badge.textContent = completed;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function claimMission(missionId) {
            const mission = MISSIONS.find(m => m.id === missionId);
            if (!mission || gameState.completedMissions.includes(missionId)) return;
            
            let progress = 0;
            switch (mission.type) {
                case 'taps': progress = gameState.todayTaps; break;
                case 'earnings': progress = gameState.todayEarnings; break;
                case 'upgrades': progress = gameState.todayUpgrades; break;
                case 'boosters': progress = gameState.todayBoosters; break;
            }
            
            if (progress < mission.target) {
                showNotification('‚ùå –ó–∞–¥–∞–Ω–∏–µ –µ—â—ë –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ!', 'error');
                return;
            }
            
            gameState.coins += mission.reward;
            gameState.completedMissions.push(missionId);
            
            showNotification(`üéâ –ü–æ–ª—É—á–µ–Ω–æ ${formatNumber(mission.reward)} –º–æ–Ω–µ—Ç!`, 'success');
            
            if (tg?.HapticFeedback) {
                tg.HapticFeedback.notificationOccurred('success');
            }
            
            updateUI();
            renderMissions();
            checkMissions();
            saveGame();
        }

        function renderMissions() {
            const container = document.getElementById('missionsList');
            container.innerHTML = '';
            
            MISSIONS.forEach(mission => {
                const isCompleted = gameState.completedMissions.includes(mission.id);
                
                let progress = 0;
                switch (mission.type) {
                    case 'taps': progress = gameState.todayTaps; break;
                    case 'earnings': progress = gameState.todayEarnings; break;
                    case 'upgrades': progress = gameState.todayUpgrades; break;
                    case 'boosters': progress = gameState.todayBoosters; break;
                }
                
                const canClaim = progress >= mission.target && !isCompleted;
                const progressPercent = Math.min(100, (progress / mission.target) * 100);
                
                container.innerHTML += `
                    <div class="mission-card rounded-xl p-4 ${isCompleted ? 'completed' : ''}">
                        <div class="flex items-center gap-3">
                            <div class="text-3xl">${mission.icon}</div>
                            <div class="flex-1">
                                <h3 class="font-semibold">${mission.name}</h3>
                                <div class="flex items-center gap-2 mt-1">
                                    <div class="flex-1 bg-slate-700 rounded-full h-2">
                                        <div class="bg-gradient-to-r from-yellow-500 to-orange-500 h-2 rounded-full transition-all" 
                                             style="width: ${progressPercent}%"></div>
                                    </div>
                                    <span class="text-sm text-gray-400">${Math.min(progress, mission.target)}/${mission.target}</span>
                                </div>
                            </div>
                            <div class="text-right">
                                ${isCompleted ? 
                                    '<span class="text-green-400">‚úì</span>' :
                                    canClaim ?
                                        `<button onclick="claimMission('${mission.id}')" 
                                            class="px-3 py-1 bg-gradient-to-r from-green-500 to-emerald-500 rounded-lg font-bold animate-pulse">
                                            ${formatNumber(mission.reward)} üí∞
                                        </button>` :
                                        `<span class="text-gray-500">${formatNumber(mission.reward)} üí∞</span>`
                                }
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Mission reset timer
            updateMissionTimer();
        }

        function updateMissionTimer() {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(0, 0, 0, 0);
            
            const diff = tomorrow - now;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            document.getElementById('missionsTimer').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // ==================== BOOSTERS ====================
        function activateBooster(boosterId) {
            const booster = BOOSTERS.find(b => b.id === boosterId);
            if (!booster) return;
            
            if (gameState.coins < booster.cost) {
                showNotification('üí∞ –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!', 'error');
                return;
            }
            
            gameState.coins -= booster.cost;
            gameState.todayBoosters += 1;
            
            if (booster.type === 'energy') {
                gameState.energy = gameState.maxEnergy;
                showNotification('üîã –≠–Ω–µ—Ä–≥–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!', 'success');
            } else {
                gameState.activeBooster = booster;
                gameState.boosterEndTime = Date.now() + (booster.duration * 1000);
                showNotification(`${booster.icon} ${booster.name} –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –Ω–∞ ${booster.duration} —Å–µ–∫!`, 'success');
            }
            
            if (tg?.HapticFeedback) {
                tg.HapticFeedback.notificationOccurred('success');
            }
            
            updateUI();
            renderBoosters();
            checkMissions();
            saveGame();
        }

        function renderBoosters() {
            const container = document.getElementById('boostersList');
            container.innerHTML = '';
            
            BOOSTERS.forEach(booster => {
                const canAfford = gameState.coins >= booster.cost;
                const isActive = gameState.activeBooster?.id === booster.id && Date.now() < gameState.boosterEndTime;
                
                container.innerHTML += `
                    <div class="building-card rounded-2xl p-4 ${isActive ? 'booster-active' : ''}">
                        <div class="flex items-center gap-4">
                            <div class="text-4xl">${booster.icon}</div>
                            <div class="flex-1">
                                <h3 class="font-bold">${booster.name}</h3>
                                <p class="text-sm text-gray-400">
                                    ${booster.type === 'energy' ? 
                                        '–ü–æ–ª–Ω–æ—Å—Ç—å—é –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏—é' : 
                                        `x${booster.multiplier} –¥–æ—Ö–æ–¥ –Ω–∞ ${booster.duration} —Å–µ–∫`}
                                </p>
                            </div>
                            <div>
                                ${isActive ?
                                    '<span class="text-green-400 font-bold">–ê–∫—Ç–∏–≤–µ–Ω</span>' :
                                    `<button onclick="activateBooster('${booster.id}')" 
                                        class="px-4 py-2 rounded-xl font-bold transition-all ${canAfford ? 
                                            'bg-gradient-to-r from-purple-500 to-pink-500 hover:scale-105' : 
                                            'bg-gray-600 cursor-not-allowed'}">
                                        ${formatNumber(booster.cost)} üí∞
                                    </button>`
                                }
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // ==================== UI UPDATES ====================
        function updateUI() {
            document.getElementById('coins').textContent = formatNumber(gameState.coins);
            document.getElementById('energy').textContent = gameState.energy;
            document.getElementById('maxEnergy').textContent = gameState.maxEnergy;
            document.getElementById('cityLevel').textContent = gameState.cityLevel;
            document.getElementById('totalTaps').textContent = formatNumber(gameState.totalTaps);
            document.getElementById('incomePerTap').textContent = formatNumber(calculateTapIncome());
            document.getElementById('passiveIncome').textContent = `+${formatNumber(calculatePassiveIncome())}/—Å–µ–∫`;
            document.getElementById('tapBonus').textContent = `+${formatNumber(calculateTapIncome())} üí∞ –∑–∞ —Ç–∞–ø`;
            
            // Energy bar
            const energyPercent = (gameState.energy / gameState.maxEnergy) * 100;
            document.getElementById('energyBar').style.width = `${energyPercent}%`;
            
            // Tap button state
            const tapButton = document.getElementById('tapButton');
            if (gameState.energy <= 0) {
                tapButton.classList.add('disabled');
            } else {
                tapButton.classList.remove('disabled');
            }
            
            // Total buildings
            const totalBuildings = Object.values(gameState.buildings).reduce((a, b) => a + b, 0);
            document.getElementById('totalBuildings').textContent = totalBuildings;
            
            // Booster status
            if (gameState.activeBooster && Date.now() < gameState.boosterEndTime) {
                document.getElementById('boosterStatus').classList.remove('hidden');
                document.getElementById('boosterMultiplier').textContent = gameState.activeBooster.multiplier;
                const timeLeft = Math.ceil((gameState.boosterEndTime - Date.now()) / 1000);
                document.getElementById('boosterTime').textContent = timeLeft;
            } else {
                document.getElementById('boosterStatus').classList.add('hidden');
                gameState.activeBooster = null;
            }
        }

        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
            
            // Deactivate all tab buttons
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('bg-slate-700/50');
            });
            
            // Show selected tab
            document.getElementById(`${tabName}Tab`).classList.remove('hidden');
            
            // Activate tab button
            const activeBtn = document.getElementById(`tab-${tabName}`);
            activeBtn.classList.add('tab-active');
            activeBtn.classList.remove('bg-slate-700/50');
            
            // Render content
            if (tabName === 'buildings') renderBuildings();
            if (tabName === 'missions') renderMissions();
            if (tabName === 'boosters') renderBoosters();
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const text = document.getElementById('notificationText');
            
            text.textContent = message;
            
            const colors = {
                success: 'from-green-500 to-emerald-600',
                error: 'from-red-500 to-rose-600',
                warning: 'from-yellow-500 to-orange-600'
            };
            
            notification.querySelector('div').className = `bg-gradient-to-r ${colors[type]} rounded-xl p-4 shadow-xl notification`;
            notification.classList.remove('hidden');
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }

        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return Math.floor(num).toString();
        }

        // ==================== GAME LOOPS ====================
        function gameLoop() {
            // Energy regeneration
            if (gameState.energy < gameState.maxEnergy) {
                gameState.energy = Math.min(gameState.maxEnergy, gameState.energy + gameState.energyRegen * 0.1);
            }
            
            // Passive income
            const passiveIncome = calculatePassiveIncome();
            if (passiveIncome > 0) {
                gameState.coins += passiveIncome / 10;
                gameState.todayEarnings += passiveIncome / 10;
            }
            
            updateUI();
        }

        function createStars() {
            const container = document.getElementById('stars');
            for (let i = 0; i < 50; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 60}%`;
                star.style.animationDelay = `${Math.random() * 3}s`;
                container.appendChild(star);
            }
        }

        // ==================== INITIALIZATION ====================
        function init() {
            initTelegram();
            loadGame();
            createStars();
            updateUI();
            renderCityView();
            checkMissions();
            
            // Game loop - runs every 100ms
            setInterval(gameLoop, 100);
            
            // Save every 5 seconds
            setInterval(saveGame, 5000);
            
            // Update mission timer every second
            setInterval(updateMissionTimer, 1000);
            
            // Update booster timer
            setInterval(() => {
                if (gameState.activeBooster && Date.now() < gameState.boosterEndTime) {
                    const timeLeft = Math.ceil((gameState.boosterEndTime - Date.now()) / 1000);
                    document.getElementById('boosterTime').textContent = timeLeft;
                }
            }, 1000);
        }

        // Start the game
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
