<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üíé GemRush - Telegram Game</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Rubik', sans-serif;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            box-sizing: border-box;
        }
        
        body {
            background: #0a0a0f;
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(120, 0, 255, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(0, 200, 255, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(255, 0, 150, 0.05) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        .game-container {
            position: relative;
            z-index: 1;
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .glass-dark {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .neon-border {
            box-shadow: 
                0 0 20px rgba(139, 92, 246, 0.3),
                inset 0 0 20px rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.5);
        }

        .gradient-gold {
            background: linear-gradient(135deg, #ffd700 0%, #ff8c00 50%, #ff6347 100%);
        }

        .gradient-blue {
            background: linear-gradient(135deg, #00d4ff 0%, #5b7cfa 50%, #8b5cf6 100%);
        }

        .gradient-green {
            background: linear-gradient(135deg, #00ff87 0%, #00d4aa 50%, #00b894 100%);
        }

        .gradient-purple {
            background: linear-gradient(135deg, #a855f7 0%, #8b5cf6 50%, #6366f1 100%);
        }

        .gradient-pink {
            background: linear-gradient(135deg, #ff006e 0%, #fb5607 100%);
        }

        .gradient-cyber {
            background: linear-gradient(135deg, #00f5d4 0%, #00bbf9 50%, #9b5de5 100%);
        }

        .text-gradient {
            background: linear-gradient(135deg, #fff 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .text-glow {
            text-shadow: 0 0 30px currentColor, 0 0 60px currentColor;
        }

        .card-game {
            background: linear-gradient(145deg, rgba(30, 30, 45, 0.8) 0%, rgba(15, 15, 25, 0.9) 100%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .card-game:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 50px rgba(139, 92, 246, 0.3);
            border-color: rgba(139, 92, 246, 0.5);
        }

        .card-game:active {
            transform: scale(0.98);
        }

        .btn-game {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .btn-game::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn-game:hover::before {
            left: 100%;
        }

        .btn-game:active {
            transform: scale(0.95);
        }

        .pulse-glow {
            animation: pulseGlow 2s ease-in-out infinite;
        }

        @keyframes pulseGlow {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.4),
                            0 0 40px rgba(255, 215, 0, 0.2);
            }
            50% { 
                box-shadow: 0 0 40px rgba(255, 215, 0, 0.6),
                            0 0 80px rgba(255, 215, 0, 0.4);
            }
        }

        .float {
            animation: float 4s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-8px) rotate(2deg); }
            75% { transform: translateY(4px) rotate(-2deg); }
        }

        .bounce-in {
            animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes bounceIn {
            0% { transform: scale(0) rotate(-10deg); opacity: 0; }
            60% { transform: scale(1.1) rotate(3deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        .slide-up {
            animation: slideUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes slideUp {
            0% { transform: translateY(100px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        .shake {
            animation: shake 0.6s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-2px, 0, 0) rotate(-1deg); }
            20%, 80% { transform: translate3d(4px, 0, 0) rotate(2deg); }
            30%, 50%, 70% { transform: translate3d(-6px, 0, 0) rotate(-3deg); }
            40%, 60% { transform: translate3d(6px, 0, 0) rotate(3deg); }
        }

        .mining-hit {
            animation: miningHit 0.2s ease-out;
        }

        @keyframes miningHit {
            0% { transform: scale(1); }
            50% { transform: scale(1.3) rotate(10deg); }
            100% { transform: scale(1); }
        }

        .coin-pop {
            animation: coinPop 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
        }

        @keyframes coinPop {
            0% { transform: scale(0) translateY(0); opacity: 1; }
            50% { transform: scale(1.5) translateY(-30px); opacity: 1; }
            100% { transform: scale(0) translateY(-60px); opacity: 0; }
        }

        .spin-slot {
            animation: spinSlot 0.1s linear infinite;
        }

        @keyframes spinSlot {
            0% { transform: translateY(0); }
            100% { transform: translateY(-50px); }
        }

        .coin-flip-anim {
            animation: coinFlipAnim 0.8s ease-in-out;
            transform-style: preserve-3d;
        }

        @keyframes coinFlipAnim {
            0% { transform: rotateY(0) scale(1); }
            50% { transform: rotateY(900deg) scale(1.3); }
            100% { transform: rotateY(1800deg) scale(1); }
        }

        .progress-bar {
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .energy-bar-fill {
            background: linear-gradient(90deg, #06b6d4 0%, #3b82f6 50%, #8b5cf6 100%);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }

        .xp-bar-fill {
            background: linear-gradient(90deg, #10b981 0%, #34d399 50%, #6ee7b7 100%);
            box-shadow: 0 0 15px rgba(52, 211, 153, 0.5);
        }

        .nav-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .nav-item::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            width: 0;
            height: 3px;
            background: linear-gradient(90deg, #8b5cf6, #06b6d4);
            border-radius: 2px;
            transition: all 0.3s ease;
            transform: translateX(-50%);
        }

        .nav-item.active::after {
            width: 30px;
        }

        .nav-item.active {
            color: #a78bfa;
            transform: translateY(-3px);
        }

        .nav-item.active .nav-icon {
            transform: scale(1.2);
            filter: drop-shadow(0 0 8px rgba(167, 139, 250, 0.8));
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-backdrop {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
        }

        .reward-text {
            animation: rewardPulse 0.5s ease-out;
        }

        @keyframes rewardPulse {
            0% { transform: scale(0); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        .particle {
            position: absolute;
            pointer-events: none;
            animation: particleFly 1s ease-out forwards;
        }

        @keyframes particleFly {
            0% { opacity: 1; transform: translate(0, 0) scale(1); }
            100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0); }
        }

        .level-badge {
            background: linear-gradient(135deg, #1e1e2e 0%, #2d2d44 100%);
            border: 2px solid;
            border-image: linear-gradient(135deg, #8b5cf6, #06b6d4) 1;
        }

        .rarity-common { 
            border-color: #6b7280; 
            box-shadow: 0 0 15px rgba(107, 114, 128, 0.3);
        }
        .rarity-rare { 
            border-color: #3b82f6; 
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
        }
        .rarity-epic { 
            border-color: #8b5cf6; 
            box-shadow: 0 0 25px rgba(139, 92, 246, 0.5);
        }
        .rarity-legendary { 
            border-color: #f59e0b; 
            box-shadow: 0 0 30px rgba(245, 158, 11, 0.6);
            animation: legendaryGlow 2s ease-in-out infinite alternate;
        }

        @keyframes legendaryGlow {
            0% { box-shadow: 0 0 20px rgba(245, 158, 11, 0.4); }
            100% { box-shadow: 0 0 40px rgba(245, 158, 11, 0.8); }
        }

        .streak-fire {
            animation: firePulse 0.5s ease-in-out infinite alternate;
        }

        @keyframes firePulse {
            0% { transform: scale(1); filter: brightness(1); }
            100% { transform: scale(1.1); filter: brightness(1.3); }
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #8b5cf6, #06b6d4);
            border-radius: 3px;
        }

        .achievement-unlock {
            animation: achievementPop 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes achievementPop {
            0% { transform: translateY(100px) scale(0); opacity: 0; }
            60% { transform: translateY(-20px) scale(1.1); opacity: 1; }
            100% { transform: translateY(0) scale(1); opacity: 1; }
        }

        .slot-machine {
            background: linear-gradient(180deg, #1a1a2e 0%, #0f0f1a 100%);
            border: 3px solid #ffd700;
            box-shadow: 
                0 0 30px rgba(255, 215, 0, 0.3),
                inset 0 0 50px rgba(0, 0, 0, 0.5);
        }

        .daily-bonus-available {
            animation: dailyPulse 1.5s ease-in-out infinite;
        }

        @keyframes dailyPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.5); }
            50% { box-shadow: 0 0 40px rgba(34, 197, 94, 0.8); }
        }

        .prestige-glow {
            background: linear-gradient(135deg, #ff006e 0%, #8338ec 50%, #3a86ff 100%);
            background-size: 200% 200%;
            animation: prestigeShift 3s ease infinite;
        }

        @keyframes prestigeShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
    </style>
</head>
<body class="text-white pb-28">
    <div class="game-container">
        <!-- Header -->
        <header class="glass-dark sticky top-0 z-50 px-4 py-3 border-b border-white/5">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-3">
                    <div class="relative">
                        <div class="w-12 h-12 rounded-2xl gradient-purple flex items-center justify-center font-black text-xl shadow-lg shadow-purple-500/30">
                            <span id="playerInitial">G</span>
                        </div>
                        <div class="absolute -bottom-1 -right-1 bg-gray-900 rounded-full px-1.5 py-0.5 text-xs font-bold border border-purple-500">
                            <span id="playerLevel">1</span>
                        </div>
                    </div>
                    <div>
                        <div class="text-sm font-bold text-gray-300">–£—Ä–æ–≤–µ–Ω—å <span id="headerLevel" class="text-purple-400">1</span></div>
                        <div class="w-28 h-2.5 bg-gray-800 rounded-full overflow-hidden mt-1">
                            <div id="xpBar" class="h-full xp-bar-fill progress-bar rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <div class="glass px-3 py-2 rounded-xl flex items-center gap-2 border border-yellow-500/30">
                        <span class="text-xl">ü™ô</span>
                        <span id="coins" class="font-bold text-yellow-400">0</span>
                    </div>
                    <div class="glass px-3 py-2 rounded-xl flex items-center gap-2 border border-purple-500/30">
                        <span class="text-xl">üíé</span>
                        <span id="gems" class="font-bold text-purple-400">0</span>
                    </div>
                </div>
            </div>
            <!-- Energy Bar -->
            <div class="bg-gray-800/50 rounded-xl p-2">
                <div class="flex justify-between text-xs mb-1.5 px-1">
                    <span class="text-cyan-400 font-semibold flex items-center gap-1">
                        <span class="text-base">‚ö°</span> –≠–Ω–µ—Ä–≥–∏—è
                    </span>
                    <span class="text-gray-400">
                        <span id="currentEnergy" class="text-cyan-400 font-bold">100</span>
                        <span class="text-gray-600">/</span>
                        <span id="maxEnergy">100</span>
                    </span>
                </div>
                <div class="w-full h-4 bg-gray-900 rounded-full overflow-hidden border border-gray-700">
                    <div id="energyBar" class="h-full energy-bar-fill progress-bar rounded-full" style="width: 100%"></div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="px-4 py-4">
            <!-- Home Section -->
            <div id="homeTab" class="tab-content active">
                <div class="text-center mb-6">
                    <h1 class="text-3xl font-black text-gradient mb-2">üíé GemRush</h1>
                    <p class="text-gray-500 text-sm">–î–æ–±—ã–≤–∞–π, –∏–≥—Ä–∞–π, –ø–æ–±–µ–∂–¥–∞–π!</p>
                </div>

                <!-- Daily Bonus -->
                <div id="dailyBonusCard" class="card-game p-4 mb-4 cursor-pointer daily-bonus-available" onclick="claimDailyBonus()">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 rounded-2xl gradient-green flex items-center justify-center text-3xl float">
                            üéÅ
                        </div>
                        <div class="flex-1">
                            <h3 class="font-bold text-lg text-green-400">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å</h3>
                            <p class="text-gray-400 text-sm">–î–µ–Ω—å <span id="dailyStreak">1</span> üî•</p>
                            <p id="dailyBonusStatus" class="text-green-400 text-xs mt-1">–î–æ—Å—Ç—É–ø–Ω–æ!</p>
                        </div>
                        <div class="text-4xl">‚Üí</div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div class="card-game p-4 text-center">
                        <div class="text-3xl mb-2">üèÜ</div>
                        <div class="text-2xl font-black text-yellow-400" id="homeCoins">0</div>
                        <div class="text-xs text-gray-500">–í—Å–µ–≥–æ –º–æ–Ω–µ—Ç</div>
                    </div>
                    <div class="card-game p-4 text-center">
                        <div class="text-3xl mb-2">‚≠ê</div>
                        <div class="text-2xl font-black text-purple-400" id="homeLevel">1</div>
                        <div class="text-xs text-gray-500">–£—Ä–æ–≤–µ–Ω—å</div>
                    </div>
                </div>

                <!-- Achievements Preview -->
                <div class="card-game p-4">
                    <h3 class="font-bold mb-3 flex items-center gap-2">
                        <span class="text-xl">üèÖ</span> –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
                    </h3>
                    <div id="achievementsList" class="grid grid-cols-4 gap-2">
                        <!-- Filled by JS -->
                    </div>
                </div>
            </div>

            <!-- Work Section -->
            <div id="workTab" class="tab-content">
                <h2 class="text-2xl font-black mb-4 flex items-center gap-2">
                    <span class="text-3xl">üíº</span> 
                    <span class="text-gradient">–†–∞–±–æ—Ç–∞</span>
                </h2>
                <div class="grid gap-4">
                    <div class="card-game p-4 cursor-pointer" onclick="doWork('delivery')">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center text-3xl float shadow-lg shadow-green-500/30">üö¥</div>
                            <div class="flex-1">
                                <h3 class="font-bold text-lg">–ö—É—Ä—å–µ—Ä</h3>
                                <p class="text-gray-400 text-sm">+30-80 ü™ô | -5 ‚ö°</p>
                                <p class="text-green-400 text-xs">+10 XP</p>
                            </div>
                            <div class="text-2xl text-gray-600">‚ñ∂</div>
                        </div>
                    </div>
                    <div class="card-game p-4 cursor-pointer" onclick="doWork('office')">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-3xl float shadow-lg shadow-blue-500/30">üè¢</div>
                            <div class="flex-1">
                                <h3 class="font-bold text-lg">–û—Ñ–∏—Å</h3>
                                <p class="text-gray-400 text-sm">+80-150 ü™ô | -10 ‚ö°</p>
                                <p class="text-green-400 text-xs">+20 XP</p>
                            </div>
                            <div class="text-2xl text-gray-600">‚ñ∂</div>
                        </div>
                    </div>
                    <div class="card-game p-4 cursor-pointer" onclick="doWork('business')">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center text-3xl float shadow-lg shadow-purple-500/30">üíº</div>
                            <div class="flex-1">
                                <h3 class="font-bold text-lg">–ë–∏–∑–Ω–µ—Å</h3>
                                <p class="text-gray-400 text-sm">+200-500 ü™ô | -20 ‚ö°</p>
                                <p class="text-green-400 text-xs">+40 XP</p>
                            </div>
                            <div class="text-2xl text-gray-600">‚ñ∂</div>
                        </div>
                    </div>
                    <div class="card-game p-4 cursor-pointer neon-border" onclick="doWork('crypto')">
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 rounded-2xl prestige-glow flex items-center justify-center text-3xl float shadow-lg">‚Çø</div>
                            <div class="flex-1">
                                <h3 class="font-bold text-lg text-purple-300">–ö—Ä–∏–ø—Ç–æ—Ç—Ä–µ–π–¥–∏–Ω–≥</h3>
                                <p class="text-gray-400 text-sm">+500-2000 ü™ô | -40 ‚ö°</p>
                                <p class="text-green-400 text-xs">+100 XP | –†–∏—Å–∫ –ø–æ—Ç–µ—Ä–∏!</p>
                            </div>
                            <div class="text-2xl text-purple-400">‚ö°</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mine Section -->
            <div id="mineTab" class="tab-content">
                <h2 class="text-2xl font-black mb-4 flex items-center gap-2">
                    <span class="text-3xl">‚õèÔ∏è</span>
                    <span class="text-gradient">–®–∞—Ö—Ç–∞</span>
                </h2>
                <div class="card-game p-6 text-center mb-4">
                    <div id="mineArea" class="relative inline-block">
                        <div id="mineRock" class="text-8xl cursor-pointer select-none transition-transform" onclick="mineRock()">ü™®</div>
                        <div id="mineParticles" class="absolute inset-0 pointer-events-none"></div>
                    </div>
                    <div class="mt-4 space-y-2">
                        <p class="text-gray-400">–¢–∞–ø–∞–π —á—Ç–æ–±—ã –¥–æ–±—ã–≤–∞—Ç—å!</p>
                        <div class="flex justify-center gap-4 text-sm">
                            <span class="text-cyan-400">-3 ‚ö°</span>
                            <span class="text-yellow-400">+5-30 ü™ô</span>
                            <span class="text-purple-400">üíé 3%</span>
                        </div>
                        <div class="text-xs text-gray-500">
                            –ö–∏—Ä–∫–∞: –£—Ä.<span id="pickaxeLevelDisplay">1</span> (x<span id="pickaxeMultiplier">1.0</span>)
                        </div>
                    </div>
                </div>
                
                <div class="card-game p-4 mb-4">
                    <h3 class="font-bold mb-3 flex items-center gap-2">
                        <span>üì¶</span> –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å —Ä—É–¥—ã
                    </h3>
                    <div class="grid grid-cols-4 gap-2">
                        <div class="bg-gray-800/50 rounded-xl p-3 text-center border border-gray-700">
                            <div class="text-2xl mb-1">ite</div>
                            <div class="text-xs text-gray-500">–£–≥–æ–ª—å</div>
                            <div id="coalCount" class="font-bold text-gray-300">0</div>
                        </div>
                        <div class="bg-gray-800/50 rounded-xl p-3 text-center border border-orange-500/30">
                            <div class="text-2xl mb-1">üî∂</div>
                            <div class="text-xs text-gray-500">–ñ–µ–ª–µ–∑–æ</div>
                            <div id="ironCount" class="font-bold text-orange-400">0</div>
                        </div>
                        <div class="bg-gray-800/50 rounded-xl p-3 text-center border border-yellow-500/30">
                            <div class="text-2xl mb-1">ü•á</div>
                            <div class="text-xs text-gray-500">–ó–æ–ª–æ—Ç–æ</div>
                            <div id="goldCount" class="font-bold text-yellow-400">0</div>
                        </div>
                        <div class="bg-gray-800/50 rounded-xl p-3 text-center border border-purple-500/30">
                            <div class="text-2xl mb-1">üíé</div>
                            <div class="text-xs text-gray-500">–ê–ª–º–∞–∑—ã</div>
                            <div id="diamondCount" class="font-bold text-purple-400">0</div>
                        </div>
                    </div>
                </div>
                
                <button onclick="sellOres()" class="w-full btn-game gradient-green text-white font-bold py-4 rounded-2xl text-lg shadow-lg shadow-green-500/30">
                    üí∞ –ü—Ä–æ–¥–∞—Ç—å –≤—Å—é —Ä—É–¥—É
                </button>
            </div>

            <!-- Shop Section -->
            <div id="shopTab" class="tab-content">
                <h2 class="text-2xl font-black mb-4 flex items-center gap-2">
                    <span class="text-3xl">üõí</span>
                    <span class="text-gradient">–ú–∞–≥–∞–∑–∏–Ω</span>
                </h2>
                <div class="grid gap-3">
                    <div class="card-game p-4">
                        <div class="flex items-center gap-4">
                            <div class="w-14 h-14 rounded-xl bg-cyan-500/20 flex items-center justify-center text-3xl border border-cyan-500/30">‚ö°</div>
                            <div class="flex-1">
                                <h3 class="font-bold">–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫</h3>
                                <p class="text-gray-400 text-sm">+50 —ç–Ω–µ—Ä–≥–∏–∏</p>
                            </div>
                            <button onclick="buyItem('energy')" class="btn-game gradient-blue px-4 py-2 rounded-xl font-bold">
                                150 ü™ô
                            </button>
                        </div>
                    </div>
                    <div class="card-game p-4">
                        <div class="flex items-center gap-4">
                            <div class="w-14 h-14 rounded-xl bg-cyan-500/20 flex items-center justify-center text-3xl border border-cyan-500/30">üîã</div>
                            <div class="flex-1">
                                <h3 class="font-bold">–ú–µ–≥–∞-—ç–Ω–µ—Ä–≥–∏—è</h3>
                                <p class="text-gray-400 text-sm">–ü–æ–ª–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ</p>
                            </div>
                            <button onclick="buyItem('fullEnergy')" class="btn-game gradient-purple px-4 py-2 rounded-xl font-bold">
                                3 üíé
                            </button>
                        </div>
                    </div>
                    <div class="card-game p-4">
                        <div class="flex items-center gap-4">
                            <div class="w-14 h-14 rounded-xl bg-yellow-500/20 flex items-center justify-center text-3xl border border-yellow-500/30">‚õèÔ∏è</div>
                            <div class="flex-1">
                                <h3 class="font-bold">–£–ª—É—á—à–∏—Ç—å –∫–∏—Ä–∫—É</h3>
                                <p class="text-gray-400 text-sm">+25% –∫ –¥–æ–±—ã—á–µ</p>
                                <p id="pickaxeLevel" class="text-yellow-400 text-xs">–£—Ä–æ–≤–µ–Ω—å: 1</p>
                            </div>
                            <button onclick="buyItem('pickaxe')" class="btn-game gradient-gold px-4 py-2 rounded-xl font-bold">
                                <span id="pickaxePrice">300</span> ü™ô
                            </button>
                        </div>
                    </div>
                    <div class="card-game p-4">
                        <div class="flex items-center gap-4">
                            <div class="w-14 h-14 rounded-xl bg-green-500/20 flex items-center justify-center text-3xl border border-green-500/30">üîã</div>
                            <div class="flex-1">
                                <h3 class="font-bold">–ë–∞—Ç–∞—Ä–µ—è</h3>
                                <p class="text-gray-400 text-sm">+25 –º–∞–∫—Å. —ç–Ω–µ—Ä–≥–∏–∏</p>
                            </div>
                            <button onclick="buyItem('battery')" class="btn-game gradient-green px-4 py-2 rounded-xl font-bold">
                                <span id="batteryPrice">500</span> ü™ô
                            </button>
                        </div>
                    </div>
                    <div class="card-game p-4">
                        <div class="flex items-center gap-4">
                            <div class="w-14 h-14 rounded-xl bg-purple-500/20 flex items-center justify-center text-3xl border border-purple-500/30">üíé</div>
                            <div class="flex-1">
                                <h3 class="font-bold">10 –ì–µ–º–æ–≤</h3>
                                <p class="text-gray-400 text-sm">–ü—Ä–µ–º–∏—É–º –≤–∞–ª—é—Ç–∞</p>
                            </div>
                            <button onclick="buyItem('gems')" class="btn-game gradient-purple px-4 py-2 rounded-xl font-bold">
                                2500 ü™ô
                            </button>
                        </div>
                    </div>
                    <div class="card-game p-4 neon-border">
                        <div class="flex items-center gap-4">
                            <div class="w-14 h-14 rounded-xl prestige-glow flex items-center justify-center text-3xl">üçÄ</div>
                            <div class="flex-1">
                                <h3 class="font-bold text-green-300">–¢–∞–ª–∏—Å–º–∞–Ω —É–¥–∞—á–∏</h3>
                                <p class="text-gray-400 text-sm">+10% —à–∞–Ω—Å —Ä–µ–¥–∫–æ–π —Ä—É–¥—ã</p>
                                <p id="luckStatus" class="text-xs text-gray-500">–ù–µ –∞–∫—Ç–∏–≤–µ–Ω</p>
                            </div>
                            <button onclick="buyItem('luck')" class="btn-game gradient-green px-4 py-2 rounded-xl font-bold">
                                10 üíé
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Games Section -->
            <div id="gamesTab" class="tab-content">
                <h2 class="text-2xl font-black mb-4 flex items-center gap-2">
                    <span class="text-3xl">üéÆ</span>
                    <span class="text-gradient">–ú–∏–Ω–∏-–∏–≥—Ä—ã</span>
                </h2>
                <div class="grid gap-4">
                    <!-- Coin Flip -->
                    <div class="card-game p-5">
                        <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                            <span class="text-2xl">ü™ô</span> –ü–æ–¥–±—Ä–æ—Å –º–æ–Ω–µ—Ç—ã
                        </h3>
                        <div class="text-center mb-4">
                            <div id="coinFlipResult" class="text-7xl mb-4 inline-block">ü™ô</div>
                            <div class="flex justify-center gap-3 mb-4">
                                <button onclick="playCoinFlip('heads')" class="btn-game gradient-gold px-8 py-3 rounded-xl font-bold text-lg">
                                    ü¶Ö –û—Ä—ë–ª
                                </button>
                                <button onclick="playCoinFlip('tails')" class="btn-game gradient-purple px-8 py-3 rounded-xl font-bold text-lg">
                                    üåü –†–µ—à–∫–∞
                                </button>
                            </div>
                            <p class="text-gray-500 text-sm">–°—Ç–∞–≤–∫–∞: 100 ü™ô | –í—ã–∏–≥—Ä—ã—à: x2</p>
                        </div>
                    </div>
                    
                    <!-- Dice Game -->
                    <div class="card-game p-5">
                        <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                            <span class="text-2xl">üé≤</span> –ö–æ—Å—Ç–∏
                        </h3>
                        <div class="text-center">
                            <div class="flex justify-center gap-6 mb-4">
                                <div id="dice1" class="text-6xl">üé≤</div>
                                <div id="dice2" class="text-6xl">üé≤</div>
                            </div>
                            <button onclick="playDice()" class="btn-game gradient-blue px-8 py-3 rounded-xl font-bold text-lg">
                                üé≤ –ë—Ä–æ—Å–∏—Ç—å (50 ü™ô)
                            </button>
                            <p class="text-gray-500 text-sm mt-3">–î—É–±–ª—å = x3 | –°—É–º–º–∞ 7 = x2 | 12 = x5</p>
                        </div>
                    </div>

                    <!-- Lucky Wheel -->
                    <div class="card-game p-5">
                        <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                            <span class="text-2xl">üé°</span> –ö–æ–ª–µ—Å–æ —Ñ–æ—Ä—Ç—É–Ω—ã
                        </h3>
                        <div class="text-center">
                            <div id="wheelDisplay" class="text-6xl mb-4">üé°</div>
                            <button onclick="spinWheel()" class="btn-game prestige-glow px-8 py-3 rounded-xl font-bold text-lg text-white">
                                üé∞ –ö—Ä—É—Ç–∏—Ç—å (200 ü™ô)
                            </button>
                            <p class="text-gray-500 text-sm mt-3">–ü—Ä–∏–∑—ã: 50-1000 ü™ô –∏–ª–∏ üíé!</p>
                        </div>
                    </div>

                    <!-- Number Guess -->
                    <div class="card-game p-5">
                        <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                            <span class="text-2xl">üî¢</span> –£–≥–∞–¥–∞–π —á–∏—Å–ª–æ
                        </h3>
                        <div class="text-center">
                            <div id="guessDisplay" class="text-5xl font-black mb-4 text-cyan-400">?</div>
                            <div class="grid grid-cols-5 gap-2 mb-4">
                                <button onclick="guessNumber(1)" class="bg-gray-800 hover:bg-purple-600 py-3 rounded-xl font-bold transition-all">1</button>
                                <button onclick="guessNumber(2)" class="bg-gray-800 hover:bg-purple-600 py-3 rounded-xl font-bold transition-all">2</button>
                                <button onclick="guessNumber(3)" class="bg-gray-800 hover:bg-purple-600 py-3 rounded-xl font-bold transition-all">3</button>
                                <button onclick="guessNumber(4)" class="bg-gray-800 hover:bg-purple-600 py-3 rounded-xl font-bold transition-all">4</button>
                                <button onclick="guessNumber(5)" class="bg-gray-800 hover:bg-purple-600 py-3 rounded-xl font-bold transition-all">5</button>
                                <button onclick="guessNumber(6)" class="bg-gray-800 hover:bg-purple-600 py-3 rounded-xl font-bold transition-all">6</button>
                                <button onclick="guessNumber(7)" class="bg-gray-800 hover:bg-purple-600 py-3 rounded-xl font-bold transition-all">7</button>
                                <button onclick="guessNumber(8)" class="bg-gray-800 hover:bg-purple-600 py-3 rounded-xl font-bold transition-all">8</button>
                                <button onclick="guessNumber(9)" class="bg-gray-800 hover:bg-purple-600 py-3 rounded-xl font-bold transition-all">9</button>
                                <button onclick="guessNumber(10)" class="bg-gray-800 hover:bg-purple-600 py-3 rounded-xl font-bold transition-all">10</button>
                            </div>
                            <p class="text-gray-500 text-sm">–°—Ç–∞–≤–∫–∞: 100 ü™ô | –£–≥–∞–¥–∞–ª = x10</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Casino Section -->
            <div id="casinoTab" class="tab-content">
                <h2 class="text-2xl font-black mb-4 flex items-center gap-2">
                    <span class="text-3xl">üé∞</span>
                    <span class="text-gradient">–ö–∞–∑–∏–Ω–æ</span>
                </h2>
                
                <!-- Slots -->
                <div class="card-game p-6 mb-4 slot-machine">
                    <h3 class="font-bold text-xl mb-4 text-center text-yellow-400">üé∞ –°–ª–æ—Ç-–º–∞—à–∏–Ω–∞</h3>
                    <div class="flex justify-center gap-3 mb-6">
                        <div class="w-20 h-24 bg-gray-900 rounded-xl flex items-center justify-center text-5xl border-2 border-yellow-500/50 overflow-hidden shadow-inner">
                            <span id="slot1">üçí</span>
                        </div>
                        <div class="w-20 h-24 bg-gray-900 rounded-xl flex items-center justify-center text-5xl border-2 border-yellow-500/50 overflow-hidden shadow-inner">
                            <span id="slot2">üçã</span>
                        </div>
                        <div class="w-20 h-24 bg-gray-900 rounded-xl flex items-center justify-center text-5xl border-2 border-yellow-500/50 overflow-hidden shadow-inner">
                            <span id="slot3">üçä</span>
                        </div>
                    </div>
                    <div class="flex justify-center gap-2 mb-4 flex-wrap">
                        <button onclick="playSlots(50)" class="btn-game bg-yellow-600 hover:bg-yellow-500 px-5 py-3 rounded-xl font-bold">
                            50 ü™ô
                        </button>
                        <button onclick="playSlots(100)" class="btn-game bg-purple-600 hover:bg-purple-500 px-5 py-3 rounded-xl font-bold">
                            100 ü™ô
                        </button>
                        <button onclick="playSlots(500)" class="btn-game bg-pink-600 hover:bg-pink-500 px-5 py-3 rounded-xl font-bold">
                            500 ü™ô
                        </button>
                    </div>
                    <div class="text-center text-xs text-gray-400 space-y-1">
                        <p>üçíüçíüçí = x3 | üçãüçãüçã = x5 | üíéüíéüíé = x20</p>
                        <p>7Ô∏è‚É£7Ô∏è‚É£7Ô∏è‚É£ = x50 | –õ—é–±—ã–µ 2 = x1.5</p>
                    </div>
                </div>

                <!-- Cases -->
                <div class="card-game p-4">
                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                        <span class="text-xl">üì¶</span> –ö–µ–π—Å—ã
                    </h3>
                    <div class="grid gap-3">
                        <div class="bg-gray-800/50 rounded-xl p-4 cursor-pointer border border-gray-600 hover:border-gray-400 transition-all" onclick="openCase('common')">
                            <div class="flex items-center gap-4">
                                <div class="text-4xl">üì¶</div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-gray-300">–û–±—ã—á–Ω—ã–π –∫–µ–π—Å</h4>
                                    <p class="text-sm text-gray-500">50-200 ü™ô</p>
                                </div>
                                <div class="text-yellow-400 font-bold">100 ü™ô</div>
                            </div>
                        </div>
                        <div class="bg-blue-900/30 rounded-xl p-4 cursor-pointer border border-blue-500/50 rarity-rare" onclick="openCase('rare')">
                            <div class="flex items-center gap-4">
                                <div class="text-4xl">üéÅ</div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-blue-300">–†–µ–¥–∫–∏–π –∫–µ–π—Å</h4>
                                    <p class="text-sm text-blue-400/70">200-800 ü™ô + —à–∞–Ω—Å üíé</p>
                                </div>
                                <div class="text-yellow-400 font-bold">400 ü™ô</div>
                            </div>
                        </div>
                        <div class="bg-purple-900/30 rounded-xl p-4 cursor-pointer border border-purple-500/50 rarity-epic" onclick="openCase('epic')">
                            <div class="flex items-center gap-4">
                                <div class="text-4xl">üíú</div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-purple-300">–≠–ø–∏—á–µ—Å–∫–∏–π –∫–µ–π—Å</h4>
                                    <p class="text-sm text-purple-400/70">500-2000 ü™ô + üíé</p>
                                </div>
                                <div class="text-purple-400 font-bold">5 üíé</div>
                            </div>
                        </div>
                        <div class="bg-yellow-900/30 rounded-xl p-4 cursor-pointer border-2 border-yellow-500 rarity-legendary" onclick="openCase('legendary')">
                            <div class="flex items-center gap-4">
                                <div class="text-4xl streak-fire">üëë</div>
                                <div class="flex-1">
                                    <h4 class="font-bold text-yellow-300">–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –∫–µ–π—Å</h4>
                                    <p class="text-sm text-yellow-400/70">2000-15000 ü™ô + –º–Ω–æ–≥–æ üíé!</p>
                                </div>
                                <div class="text-purple-400 font-bold">25 üíé</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profile Section -->
            <div id="profileTab" class="tab-content">
                <h2 class="text-2xl font-black mb-4 flex items-center gap-2">
                    <span class="text-3xl">üë§</span>
                    <span class="text-gradient">–ü—Ä–æ—Ñ–∏–ª—å</span>
                </h2>
                <div class="card-game p-6 text-center mb-4">
                    <div class="w-24 h-24 mx-auto rounded-3xl gradient-purple flex items-center justify-center text-5xl mb-4 shadow-lg shadow-purple-500/30">
                        <span id="profileAvatar">üéÆ</span>
                    </div>
                    <h3 class="text-2xl font-black mb-1" id="playerName">–ò–≥—Ä–æ–∫</h3>
                    <p class="text-purple-400 mb-4">–£—Ä–æ–≤–µ–Ω—å <span id="profileLevel">1</span></p>
                    <div class="bg-gray-800/50 rounded-xl p-3 mb-2">
                        <div class="flex justify-between text-sm mb-2">
                            <span class="text-gray-400">–û–ø—ã—Ç</span>
                            <span class="text-green-400"><span id="currentXp">0</span> / <span id="neededXp">100</span></span>
                        </div>
                        <div class="w-full h-4 bg-gray-900 rounded-full overflow-hidden">
                            <div id="profileXpBar" class="h-full xp-bar-fill progress-bar rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="card-game p-4 mb-4">
                    <h3 class="font-bold mb-3 flex items-center gap-2">
                        <span>üìä</span> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                    </h3>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-gray-800/50 rounded-xl p-3 text-center">
                            <div class="text-2xl mb-1">ü™ô</div>
                            <div class="text-xs text-gray-500">–í—Å–µ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
                            <div id="totalEarned" class="font-bold text-yellow-400">0</div>
                        </div>
                        <div class="bg-gray-800/50 rounded-xl p-3 text-center">
                            <div class="text-2xl mb-1">üéÆ</div>
                            <div class="text-xs text-gray-500">–ò–≥—Ä —Å—ã–≥—Ä–∞–Ω–æ</div>
                            <div id="gamesPlayed" class="font-bold text-blue-400">0</div>
                        </div>
                        <div class="bg-gray-800/50 rounded-xl p-3 text-center">
                            <div class="text-2xl mb-1">‚õèÔ∏è</div>
                            <div class="text-xs text-gray-500">–î–æ–±—ã—Ç–æ —Ä—É–¥—ã</div>
                            <div id="totalMined" class="font-bold text-orange-400">0</div>
                        </div>
                        <div class="bg-gray-800/50 rounded-xl p-3 text-center">
                            <div class="text-2xl mb-1">üèÜ</div>
                            <div class="text-xs text-gray-500">–ü–æ–±–µ–¥ –≤ –∫–∞–∑–∏–Ω–æ</div>
                            <div id="casinoWins" class="font-bold text-green-400">0</div>
                        </div>
                        <div class="bg-gray-800/50 rounded-xl p-3 text-center">
                            <div class="text-2xl mb-1">üî•</div>
                            <div class="text-xs text-gray-500">–°–µ—Ä–∏—è –¥–Ω–µ–π</div>
                            <div id="profileStreak" class="font-bold text-red-400">0</div>
                        </div>
                        <div class="bg-gray-800/50 rounded-xl p-3 text-center">
                            <div class="text-2xl mb-1">‚è±Ô∏è</div>
                            <div class="text-xs text-gray-500">–í—Ä–µ–º—è –≤ –∏–≥—Ä–µ</div>
                            <div id="playTime" class="font-bold text-cyan-400">0–º</div>
                        </div>
                    </div>
                </div>

                <button onclick="resetProgress()" class="w-full bg-red-900/30 border border-red-500/30 text-red-400 font-bold py-3 rounded-xl hover:bg-red-900/50 transition-all">
                    üîÑ –°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
                </button>
            </div>
        </main>

        <!-- Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 glass-dark border-t border-white/5 px-2 py-3 z-50">
            <div class="flex justify-around max-w-lg mx-auto">
                <button onclick="showTab('home')" class="nav-item active flex flex-col items-center px-3 py-1" data-tab="home">
                    <span class="nav-icon text-2xl transition-transform">üè†</span>
                    <span class="text-xs mt-1">–î–æ–º</span>
                </button>
                <button onclick="showTab('work')" class="nav-item flex flex-col items-center px-3 py-1" data-tab="work">
                    <span class="nav-icon text-2xl transition-transform">üíº</span>
                    <span class="text-xs mt-1">–†–∞–±–æ—Ç–∞</span>
                </button>
                <button onclick="showTab('mine')" class="nav-item flex flex-col items-center px-3 py-1" data-tab="mine">
                    <span class="nav-icon text-2xl transition-transform">‚õèÔ∏è</span>
                    <span class="text-xs mt-1">–®–∞—Ö—Ç–∞</span>
                </button>
                <button onclick="showTab('shop')" class="nav-item flex flex-col items-center px-3 py-1" data-tab="shop">
                    <span class="nav-icon text-2xl transition-transform">üõí</span>
                    <span class="text-xs mt-1">–ú–∞–≥–∞–∑–∏–Ω</span>
                </button>
                <button onclick="showTab('games')" class="nav-item flex flex-col items-center px-3 py-1" data-tab="games">
                    <span class="nav-icon text-2xl transition-transform">üéÆ</span>
                    <span class="text-xs mt-1">–ò–≥—Ä—ã</span>
                </button>
                <button onclick="showTab('casino')" class="nav-item flex flex-col items-center px-3 py-1" data-tab="casino">
                    <span class="nav-icon text-2xl transition-transform">üé∞</span>
                    <span class="text-xs mt-1">–ö–∞–∑–∏–Ω–æ</span>
                </button>
                <button onclick="showTab('profile')" class="nav-item flex flex-col items-center px-3 py-1" data-tab="profile">
                    <span class="nav-icon text-2xl transition-transform">üë§</span>
                    <span class="text-xs mt-1">–ü—Ä–æ—Ñ–∏–ª—å</span>
                </button>
            </div>
        </nav>

        <!-- Modal -->
        <div id="modal" class="fixed inset-0 modal-backdrop z-50 hidden items-center justify-center p-4" style="display: none;">
            <div class="card-game p-6 max-w-sm w-full bounce-in">
                <div id="modalContent" class="text-center">
                    <!-- Dynamic content -->
                </div>
                <button onclick="closeModal()" class="w-full mt-4 bg-gray-700 hover:bg-gray-600 py-3 rounded-xl font-bold transition-all">
                    –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
        </div>

        <!-- Toast -->
        <div id="toast" class="fixed top-24 left-1/2 -translate-x-1/2 glass-dark px-6 py-3 rounded-2xl z-50 transition-all duration-300 opacity-0 pointer-events-none border border-white/10">
            <span id="toastText"></span>
        </div>
    </div>

    <script>
        // ============ GAME STATE ============
        const DEFAULT_STATE = {
            coins: 500,
            gems: 5,
            energy: 100,
            maxEnergy: 100,
            level: 1,
            xp: 0,
            xpNeeded: 100,
            pickaxeLevel: 1,
            batteryLevel: 1,
            hasLuckCharm: false,
            ores: { coal: 0, iron: 0, gold: 0, diamond: 0 },
            stats: {
                totalEarned: 0,
                gamesPlayed: 0,
                totalMined: 0,
                casinoWins: 0,
                dailyStreak: 0,
                playTimeMinutes: 0
            },
            lastDaily: null,
            lastEnergyRegen: Date.now(),
            achievements: [],
            createdAt: Date.now()
        };

        let gameState = JSON.parse(JSON.stringify(DEFAULT_STATE));
        let isAnimating = false;
        let playTimeInterval = null;

        // ============ STORAGE ============
        const STORAGE_KEY = 'gemrush_save_v2';

        function saveGame() {
            try {
                gameState.lastSave = Date.now();
                localStorage.setItem(STORAGE_KEY, JSON.stringify(gameState));
            } catch (e) {
                console.error('Save failed:', e);
            }
        }

        function loadGame() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    // Merge with defaults to handle new properties
                    gameState = { ...JSON.parse(JSON.stringify(DEFAULT_STATE)), ...parsed };
                    // Ensure nested objects are merged
                    gameState.ores = { ...DEFAULT_STATE.ores, ...parsed.ores };
                    gameState.stats = { ...DEFAULT_STATE.stats, ...parsed.stats };
                    
                    // Calculate offline energy regeneration
                    calculateOfflineProgress();
                }
                updateAllUI();
                checkDailyBonus();
            } catch (e) {
                console.error('Load failed:', e);
                gameState = JSON.parse(JSON.stringify(DEFAULT_STATE));
            }
        }

        function calculateOfflineProgress() {
            const now = Date.now();
            const lastRegen = gameState.lastEnergyRegen || now;
            const offlineSeconds = Math.floor((now - lastRegen) / 1000);
            const energyGained = Math.floor(offlineSeconds / 6); // 1 energy per 6 seconds
            
            if (energyGained > 0) {
                const oldEnergy = gameState.energy;
                gameState.energy = Math.min(gameState.energy + energyGained, gameState.maxEnergy);
                const actualGain = gameState.energy - oldEnergy;
                
                if (actualGain > 0) {
                    setTimeout(() => {
                        showToast(`‚ö° +${actualGain} —ç–Ω–µ—Ä–≥–∏–∏ –∑–∞ –≤—Ä–µ–º—è –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è!`, 'success');
                    }, 1000);
                }
            }
            gameState.lastEnergyRegen = now;
        }

        function resetProgress() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω!')) {
                localStorage.removeItem(STORAGE_KEY);
                gameState = JSON.parse(JSON.stringify(DEFAULT_STATE));
                updateAllUI();
                showToast('–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–±—Ä–æ—à–µ–Ω', 'info');
            }
        }

        // ============ UI UPDATES ============
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return Math.floor(num).toString();
        }

        function updateAllUI() {
            // Header
            document.getElementById('coins').textContent = formatNumber(gameState.coins);
            document.getElementById('gems').textContent = gameState.gems;
            document.getElementById('currentEnergy').textContent = Math.floor(gameState.energy);
            document.getElementById('maxEnergy').textContent = gameState.maxEnergy;
            document.getElementById('energyBar').style.width = (gameState.energy / gameState.maxEnergy * 100) + '%';
            document.getElementById('playerLevel').textContent = gameState.level;
            document.getElementById('headerLevel').textContent = gameState.level;
            document.getElementById('xpBar').style.width = (gameState.xp / gameState.xpNeeded * 100) + '%';
            
            // Home
            document.getElementById('homeCoins').textContent = formatNumber(gameState.coins);
            document.getElementById('homeLevel').textContent = gameState.level;
            document.getElementById('dailyStreak').textContent = gameState.stats.dailyStreak;
            
            // Mine
            document.getElementById('coalCount').textContent = gameState.ores.coal;
            document.getElementById('ironCount').textContent = gameState.ores.iron;
            document.getElementById('goldCount').textContent = gameState.ores.gold;
            document.getElementById('diamondCount').textContent = gameState.ores.diamond;
            document.getElementById('pickaxeLevelDisplay').textContent = gameState.pickaxeLevel;
            document.getElementById('pickaxeMultiplier').textContent = (1 + (gameState.pickaxeLevel - 1) * 0.25).toFixed(2);
            
            // Shop
            document.getElementById('pickaxeLevel').textContent = '–£—Ä–æ–≤–µ–Ω—å: ' + gameState.pickaxeLevel;
            document.getElementById('pickaxePrice').textContent = 300 * gameState.pickaxeLevel;
            document.getElementById('batteryPrice').textContent = 500 * gameState.batteryLevel;
            document.getElementById('luckStatus').textContent = gameState.hasLuckCharm ? '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω!' : '–ù–µ –∞–∫—Ç–∏–≤–µ–Ω';
            
            // Profile
            document.getElementById('profileLevel').textContent = gameState.level;
            document.getElementById('currentXp').textContent = gameState.xp;
            document.getElementById('neededXp').textContent = gameState.xpNeeded;
            document.getElementById('profileXpBar').style.width = (gameState.xp / gameState.xpNeeded * 100) + '%';
            document.getElementById('totalEarned').textContent = formatNumber(gameState.stats.totalEarned);
            document.getElementById('gamesPlayed').textContent = gameState.stats.gamesPlayed;
            document.getElementById('totalMined').textContent = gameState.stats.totalMined;
            document.getElementById('casinoWins').textContent = gameState.stats.casinoWins;
            document.getElementById('profileStreak').textContent = gameState.stats.dailyStreak;
            document.getElementById('playTime').textContent = formatPlayTime(gameState.stats.playTimeMinutes);
            
            updateAchievements();
            saveGame();
        }

        function formatPlayTime(minutes) {
            if (minutes < 60) return minutes + '–º';
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return hours + '—á ' + mins + '–º';
        }

        // ============ TABS ============
        function showTab(tab) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            hapticFeedback('light');
        }

        // ============ NOTIFICATIONS ============
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastText = document.getElementById('toastText');
            toastText.textContent = message;
            
            toast.className = 'fixed top-24 left-1/2 -translate-x-1/2 glass-dark px-6 py-3 rounded-2xl z-50 transition-all duration-300 border';
            
            if (type === 'success') {
                toast.classList.add('border-green-500/50');
            } else if (type === 'error') {
                toast.classList.add('border-red-500/50');
            } else {
                toast.classList.add('border-white/10');
            }
            
            toast.style.opacity = '1';
            toast.style.pointerEvents = 'auto';
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.pointerEvents = 'none';
            }, 2500);
        }

        function showModal(title, message, emoji = 'üéâ') {
            const modal = document.getElementById('modal');
            const content = document.getElementById('modalContent');
            content.innerHTML = `
                <div class="text-7xl mb-4 reward-text">${emoji}</div>
                <h3 class="text-2xl font-black mb-2">${title}</h3>
                <p class="text-gray-400">${message}</p>
            `;
            modal.style.display = 'flex';
            hapticFeedback('success');
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // ============ XP & LEVELING ============
        function addXP(amount) {
            gameState.xp += amount;
            
            while (gameState.xp >= gameState.xpNeeded) {
                gameState.xp -= gameState.xpNeeded;
                gameState.level++;
                gameState.xpNeeded = Math.floor(100 * Math.pow(1.4, gameState.level - 1));
                
                // Level up rewards
                const coinBonus = gameState.level * 100;
                const gemBonus = gameState.level >= 5 ? Math.floor(gameState.level / 5) : 0;
                gameState.coins += coinBonus;
                gameState.gems += gemBonus;
                
                let rewardText = `+${coinBonus} ü™ô`;
                if (gemBonus > 0) rewardText += ` +${gemBonus} üíé`;
                
                showModal('üéâ –£—Ä–æ–≤–µ–Ω—å ' + gameState.level + '!', rewardText, '‚¨ÜÔ∏è');
                hapticFeedback('success');
            }
            
            updateAllUI();
        }

        // ============ DAILY BONUS ============
        function checkDailyBonus() {
            const now = new Date();
            const today = now.toDateString();
            const card = document.getElementById('dailyBonusCard');
            const status = document.getElementById('dailyBonusStatus');
            
            if (gameState.lastDaily === today) {
                card.classList.remove('daily-bonus-available');
                card.style.opacity = '0.5';
                status.textContent = '–£–∂–µ –ø–æ–ª—É—á–µ–Ω–æ!';
                status.className = 'text-gray-500 text-xs mt-1';
            } else {
                card.classList.add('daily-bonus-available');
                card.style.opacity = '1';
                status.textContent = '–ó–∞–±—Ä–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É!';
                status.className = 'text-green-400 text-xs mt-1';
            }
        }

        function claimDailyBonus() {
            const now = new Date();
            const today = now.toDateString();
            
            if (gameState.lastDaily === today) {
                showToast('–ë–æ–Ω—É—Å —É–∂–µ –ø–æ–ª—É—á–µ–Ω —Å–µ–≥–æ–¥–Ω—è!', 'error');
                return;
            }
            
            // Check streak
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (gameState.lastDaily === yesterday.toDateString()) {
                gameState.stats.dailyStreak++;
            } else if (gameState.lastDaily !== today) {
                gameState.stats.dailyStreak = 1;
            }
            
            gameState.lastDaily = today;
            
            // Calculate rewards based on streak
            const streak = gameState.stats.dailyStreak;
            const coinReward = 100 * streak;
            const gemReward = streak >= 7 ? Math.floor(streak / 7) * 2 : 0;
            const energyReward = 50;
            
            gameState.coins += coinReward;
            gameState.gems += gemReward;
            gameState.energy = Math.min(gameState.energy + energyReward, gameState.maxEnergy);
            
            let msg = `+${coinReward} ü™ô +${energyReward} ‚ö°`;
            if (gemReward > 0) msg += ` +${gemReward} üíé`;
            
            showModal(`üî• –î–µ–Ω—å ${streak}!`, msg, 'üéÅ');
            checkDailyBonus();
            updateAllUI();
        }

        // ============ WORK ============
        function doWork(type) {
            const works = {
                delivery: { min: 30, max: 80, energy: 5, xp: 10, risk: 0 },
                office: { min: 80, max: 150, energy: 10, xp: 20, risk: 0 },
                business: { min: 200, max: 500, energy: 20, xp: 40, risk: 0 },
                crypto: { min: -500, max: 2000, energy: 40, xp: 100, risk: 0.3 }
            };
            
            const work = works[type];
            
            if (gameState.energy < work.energy) {
                showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —ç–Ω–µ—Ä–≥–∏–∏!', 'error');
                hapticFeedback('error');
                return;
            }
            
            gameState.energy -= work.energy;
            
            let reward;
            if (type === 'crypto' && Math.random() < work.risk) {
                // Lost money in crypto
                reward = Math.floor(Math.random() * 300) * -1;
                gameState.coins = Math.max(0, gameState.coins + reward);
                showToast(`üìâ –ö—Ä–∏–ø—Ç–æ —É–ø–∞–ª–æ! ${reward} ü™ô`, 'error');
            } else {
                reward = Math.floor(Math.random() * (work.max - work.min + 1)) + work.min;
                if (reward < 0) reward = 0;
                gameState.coins += reward;
                gameState.stats.totalEarned += reward;
                showToast(`+${reward} ü™ô | +${work.xp} XP`, 'success');
            }
            
            addXP(work.xp);
            hapticFeedback('medium');
            updateAllUI();
        }

        // ============ MINING ============
        function mineRock() {
            if (isAnimating) return;
            
            if (gameState.energy < 3) {
                showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —ç–Ω–µ—Ä–≥–∏–∏!', 'error');
                hapticFeedback('error');
                return;
            }
            
            isAnimating = true;
            gameState.energy -= 3;
            gameState.stats.totalMined++;
            
            const rock = document.getElementById('mineRock');
            rock.classList.add('mining-hit');
            
            // Create particles
            createMiningParticles();
            
            setTimeout(() => {
                rock.classList.remove('mining-hit');
                isAnimating = false;
            }, 200);
            
            const bonus = 1 + (gameState.pickaxeLevel - 1) * 0.25;
            const luckBonus = gameState.hasLuckCharm ? 0.1 : 0;
            const roll = Math.random();
            
            let message = '';
            
            if (roll < 0.03 + luckBonus) {
                // Diamond!
                gameState.ores.diamond++;
                gameState.gems += Math.random() < 0.2 ? 1 : 0;
                message = 'üíé –ê–ª–º–∞–∑ –Ω–∞–π–¥–µ–Ω!';
                hapticFeedback('success');
            } else if (roll < 0.10 + luckBonus) {
                const amt = Math.ceil((Math.floor(Math.random() * 2) + 1) * bonus);
                gameState.ores.gold += amt;
                message = `+${amt} ü•á –ó–æ–ª–æ—Ç–æ!`;
                hapticFeedback('medium');
            } else if (roll < 0.30 + luckBonus) {
                const amt = Math.ceil((Math.floor(Math.random() * 3) + 1) * bonus);
                gameState.ores.iron += amt;
                message = `+${amt} üî∂ –ñ–µ–ª–µ–∑–æ`;
                hapticFeedback('light');
            } else {
                const amt = Math.ceil((Math.floor(Math.random() * 5) + 2) * bonus);
                gameState.ores.coal += amt;
                message = `+${amt} ite –£–≥–æ–ª—å`;
                hapticFeedback('light');
            }
            
            // Direct coin reward
            const coinReward = Math.floor((Math.random() * 25 + 5) * bonus);
            gameState.coins += coinReward;
            gameState.stats.totalEarned += coinReward;
            
            showToast(`${message} +${coinReward} ü™ô`, 'success');
            addXP(3);
            updateAllUI();
        }

        function createMiningParticles() {
            const container = document.getElementById('mineParticles');
            const particles = ['‚ú®', 'üí´', '‚≠ê', 'ü™ô'];
            
            for (let i = 0; i < 5; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.textContent = particles[Math.floor(Math.random() * particles.length)];
                particle.style.left = '50%';
                particle.style.top = '50%';
                particle.style.setProperty('--tx', (Math.random() * 100 - 50) + 'px');
                particle.style.setProperty('--ty', (Math.random() * -80 - 20) + 'px');
                particle.style.fontSize = '20px';
                container.appendChild(particle);
                
                setTimeout(() => particle.remove(), 1000);
            }
        }

        function sellOres() {
            const prices = { coal: 3, iron: 12, gold: 50, diamond: 150 };
            let total = 0;
            
            for (const [ore, count] of Object.entries(gameState.ores)) {
                total += count * prices[ore];
            }
            
            if (total === 0) {
                showToast('–ù–µ—Ç —Ä—É–¥—ã –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏!', 'error');
                return;
            }
            
            gameState.coins += total;
            gameState.stats.totalEarned += total;
            gameState.ores = { coal: 0, iron: 0, gold: 0, diamond: 0 };
            
            showToast(`+${total} ü™ô –æ—Ç –ø—Ä–æ–¥–∞–∂–∏!`, 'success');
            hapticFeedback('success');
            addXP(Math.floor(total / 10));
            updateAllUI();
        }

        // ============ SHOP ============
        function buyItem(item) {
            switch(item) {
                case 'energy':
                    if (gameState.coins < 150) {
                        showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!', 'error');
                        return;
                    }
                    gameState.coins -= 150;
                    gameState.energy = Math.min(gameState.energy + 50, gameState.maxEnergy);
                    showToast('+50 ‚ö°', 'success');
                    break;
                    
                case 'fullEnergy':
                    if (gameState.gems < 3) {
                        showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≥–µ–º–æ–≤!', 'error');
                        return;
                    }
                    gameState.gems -= 3;
                    gameState.energy = gameState.maxEnergy;
                    showToast('‚ö° –ü–æ–ª–Ω–∞—è —ç–Ω–µ—Ä–≥–∏—è!', 'success');
                    break;
                    
                case 'pickaxe':
                    const pickPrice = 300 * gameState.pickaxeLevel;
                    if (gameState.coins < pickPrice) {
                        showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!', 'error');
                        return;
                    }
                    gameState.coins -= pickPrice;
                    gameState.pickaxeLevel++;
                    showToast(`‚õèÔ∏è –ö–∏—Ä–∫–∞ –£—Ä.${gameState.pickaxeLevel}!`, 'success');
                    break;
                    
                case 'battery':
                    const batPrice = 500 * gameState.batteryLevel;
                    if (gameState.coins < batPrice) {
                        showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!', 'error');
                        return;
                    }
                    gameState.coins -= batPrice;
                    gameState.maxEnergy += 25;
                    gameState.batteryLevel++;
                    showToast(`+25 –º–∞–∫—Å ‚ö° (${gameState.maxEnergy})`, 'success');
                    break;
                    
                case 'gems':
                    if (gameState.coins < 2500) {
                        showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!', 'error');
                        return;
                    }
                    gameState.coins -= 2500;
                    gameState.gems += 10;
                    showToast('+10 üíé', 'success');
                    break;
                    
                case 'luck':
                    if (gameState.hasLuckCharm) {
                        showToast('–£–∂–µ –∞–∫—Ç–∏–≤–µ–Ω!', 'error');
                        return;
                    }
                    if (gameState.gems < 10) {
                        showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≥–µ–º–æ–≤!', 'error');
                        return;
                    }
                    gameState.gems -= 10;
                    gameState.hasLuckCharm = true;
                    showToast('üçÄ –¢–∞–ª–∏—Å–º–∞–Ω –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!', 'success');
                    break;
            }
            
            hapticFeedback('medium');
            updateAllUI();
        }

        // ============ GAMES ============
        function playCoinFlip(choice) {
            if (isAnimating) return;
            if (gameState.coins < 100) {
                showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!', 'error');
                return;
            }
            
            isAnimating = true;
            gameState.coins -= 100;
            gameState.stats.gamesPlayed++;
            
            const coin = document.getElementById('coinFlipResult');
            coin.classList.add('coin-flip-anim');
            
            setTimeout(() => {
                coin.classList.remove('coin-flip-anim');
                const result = Math.random() < 0.5 ? 'heads' : 'tails';
                coin.textContent = result === 'heads' ? 'ü¶Ö' : 'üåü';
                
                if (result === choice) {
                    gameState.coins += 200;
                    gameState.stats.totalEarned += 200;
                    gameState.stats.casinoWins++;
                    showToast('+200 ü™ô –ü–æ–±–µ–¥–∞!', 'success');
                    hapticFeedback('success');
                } else {
                    showToast('–ù–µ –ø–æ–≤–µ–∑–ª–æ!', 'error');
                    hapticFeedback('error');
                }
                
                addXP(10);
                updateAllUI();
                isAnimating = false;
                
                setTimeout(() => coin.textContent = 'ü™ô', 2000);
            }, 800);
        }

        const diceEmojis = ['‚öÄ', '‚öÅ', '‚öÇ', '‚öÉ', '‚öÑ', '‚öÖ'];
        
        function playDice() {
            if (isAnimating) return;
            if (gameState.coins < 50) {
                showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!', 'error');
                return;
            }
            
            isAnimating = true;
            gameState.coins -= 50;
            gameState.stats.gamesPlayed++;
            
            const dice1 = document.getElementById('dice1');
            const dice2 = document.getElementById('dice2');
            
            let rolls = 0;
            const rollInterval = setInterval(() => {
                dice1.textContent = diceEmojis[Math.floor(Math.random() * 6)];
                dice2.textContent = diceEmojis[Math.floor(Math.random() * 6)];
                dice1.classList.add('shake');
                dice2.classList.add('shake');
                rolls++;
                
                if (rolls > 12) {
                    clearInterval(rollInterval);
                    dice1.classList.remove('shake');
                    dice2.classList.remove('shake');
                    
                    const r1 = Math.floor(Math.random() * 6) + 1;
                    const r2 = Math.floor(Math.random() * 6) + 1;
                    dice1.textContent = diceEmojis[r1 - 1];
                    dice2.textContent = diceEmojis[r2 - 1];
                    
                    let win = 0;
                    if (r1 === r2) {
                        win = r1 === 6 ? 250 : 150;
                    } else if (r1 + r2 === 7) {
                        win = 100;
                    } else if (r1 + r2 === 12) {
                        win = 250;
                    }
                    
                    if (win > 0) {
                        gameState.coins += win;
                        gameState.stats.totalEarned += win;
                        gameState.stats.casinoWins++;
                        showToast(`+${win} ü™ô –ü–æ–±–µ–¥–∞!`, 'success');
                        hapticFeedback('success');
                    } else {
                        showToast(`–°—É–º–º–∞: ${r1 + r2}. –ù–µ –ø–æ–≤–µ–∑–ª–æ!`, 'error');
                        hapticFeedback('error');
                    }
                    
                    addXP(10);
                    updateAllUI();
                    isAnimating = false;
                }
            }, 80);
        }

        function spinWheel() {
            if (isAnimating) return;
            if (gameState.coins < 200) {
                showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!', 'error');
                return;
            }
            
            isAnimating = true;
            gameState.coins -= 200;
            gameState.stats.gamesPlayed++;
            
            const wheel = document.getElementById('wheelDisplay');
            const prizes = [50, 100, 150, 200, 300, 500, 1000];
            const gemPrize = Math.random() < 0.1;
            
            let spins = 0;
            const spinInterval = setInterval(() => {
                wheel.textContent = ['üé°', 'üé†', 'üé™', 'üéØ'][spins % 4];
                wheel.style.transform = `rotate(${spins * 30}deg)`;
                spins++;
                
                if (spins > 20) {
                    clearInterval(spinInterval);
                    wheel.style.transform = 'rotate(0deg)';
                    
                    if (gemPrize) {
                        const gems = Math.floor(Math.random() * 3) + 1;
                        gameState.gems += gems;
                        wheel.textContent = 'üíé';
                        showModal('üíé –ì–ï–ú–´!', `+${gems} üíé`, 'üé°');
                    } else {
                        const prize = prizes[Math.floor(Math.random() * prizes.length)];
                        gameState.coins += prize;
                        gameState.stats.totalEarned += prize;
                        wheel.textContent = 'üèÜ';
                        
                        if (prize >= 500) {
                            showModal('üéâ –ë–æ–ª—å—à–æ–π –ø—Ä–∏–∑!', `+${prize} ü™ô`, 'üé°');
                            gameState.stats.casinoWins++;
                        } else {
                            showToast(`+${prize} ü™ô`, 'success');
                        }
                    }
                    
                    hapticFeedback('success');
                    addXP(20);
                    updateAllUI();
                    isAnimating = false;
                    
                    setTimeout(() => wheel.textContent = 'üé°', 2000);
                }
            }, 100);
        }

        function guessNumber(num) {
            if (isAnimating) return;
            if (gameState.coins < 100) {
                showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!', 'error');
                return;
            }
            
            isAnimating = true;
            gameState.coins -= 100;
            gameState.stats.gamesPlayed++;
            
            const display = document.getElementById('guessDisplay');
            let rolls = 0;
            
            const rollInterval = setInterval(() => {
                display.textContent = Math.floor(Math.random() * 10) + 1;
                rolls++;
                
                if (rolls > 15) {
                    clearInterval(rollInterval);
                    const result = Math.floor(Math.random() * 10) + 1;
                    display.textContent = result;
                    
                    if (result === num) {
                        gameState.coins += 1000;
                        gameState.stats.totalEarned += 1000;
                        gameState.stats.casinoWins++;
                        showModal('üéâ –î–ñ–ï–ö–ü–û–¢!', '+1000 ü™ô –£–≥–∞–¥–∞–ª!', 'üî¢');
                        hapticFeedback('success');
                    } else {
                        showToast(`–ë—ã–ª–æ: ${result}. –ù–µ –ø–æ–≤–µ–∑–ª–æ!`, 'error');
                        hapticFeedback('error');
                    }
                    
                    addXP(10);
                    updateAllUI();
                    isAnimating = false;
                    
                    setTimeout(() => display.textContent = '?', 2000);
                }
            }, 80);
        }

        // ============ CASINO ============
        const slotSymbols = ['üçí', 'üçã', 'üçä', 'üçá', '‚≠ê', 'üíé', '7Ô∏è‚É£'];
        
        function playSlots(bet) {
            if (isAnimating) return;
            if (gameState.coins < bet) {
                showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!', 'error');
                return;
            }
            
            isAnimating = true;
            gameState.coins -= bet;
            gameState.stats.gamesPlayed++;
            
            const slot1 = document.getElementById('slot1');
            const slot2 = document.getElementById('slot2');
            const slot3 = document.getElementById('slot3');
            
            let rolls = 0;
            const rollInterval = setInterval(() => {
                slot1.textContent = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
                slot2.textContent = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
                slot3.textContent = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
                rolls++;
                
                if (rolls > 20) {
                    clearInterval(rollInterval);
                    
                    const r1 = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
                    const r2 = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
                    const r3 = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
                    
                    slot1.textContent = r1;
                    slot2.textContent = r2;
                    slot3.textContent = r3;
                    
                    let multiplier = 0;
                    
                    if (r1 === r2 && r2 === r3) {
                        multiplier = r1 === '7Ô∏è‚É£' ? 50 : r1 === 'üíé' ? 20 : r1 === '‚≠ê' ? 10 : r1 === 'üçá' ? 7 : r1 === 'üçã' ? 5 : 3;
                    } else if (r1 === r2 || r2 === r3 || r1 === r3) {
                        multiplier = 1.5;
                    }
                    
                    if (multiplier > 0) {
                        const win = Math.floor(bet * multiplier);
                        gameState.coins += win;
                        gameState.stats.totalEarned += win;
                        gameState.stats.casinoWins++;
                        
                        if (multiplier >= 10) {
                            showModal('üé∞ –î–ñ–ï–ö–ü–û–¢!', `+${win} ü™ô (x${multiplier})`, 'üéâ');
                        } else {
                            showToast(`+${win} ü™ô (x${multiplier})`, 'success');
                        }
                        hapticFeedback('success');
                    } else {
                        showToast('–ù–µ –ø–æ–≤–µ–∑–ª–æ!', 'error');
                        hapticFeedback('error');
                    }
                    
                    addXP(15);
                    updateAllUI();
                    isAnimating = false;
                }
            }, 80);
        }

        function openCase(type) {
            const cases = {
                common: { cost: 100, currency: 'coins', min: 50, max: 200, gemChance: 0.05, gemCount: 1 },
                rare: { cost: 400, currency: 'coins', min: 200, max: 800, gemChance: 0.15, gemCount: 2 },
                epic: { cost: 5, currency: 'gems', min: 500, max: 2000, gemChance: 0.3, gemCount: 3 },
                legendary: { cost: 25, currency: 'gems', min: 2000, max: 15000, gemChance: 0.5, gemCount: 8 }
            };
            
            const c = cases[type];
            
            if (c.currency === 'coins' && gameState.coins < c.cost) {
                showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!', 'error');
                return;
            }
            if (c.currency === 'gems' && gameState.gems < c.cost) {
                showToast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≥–µ–º–æ–≤!', 'error');
                return;
            }
            
            if (c.currency === 'coins') gameState.coins -= c.cost;
            else gameState.gems -= c.cost;
            
            gameState.stats.gamesPlayed++;
            
            const reward = Math.floor(Math.random() * (c.max - c.min + 1)) + c.min;
            const gotGem = Math.random() < c.gemChance;
            const gemCount = gotGem ? Math.floor(Math.random() * c.gemCount) + 1 : 0;
            
            gameState.coins += reward;
            gameState.stats.totalEarned += reward;
            
            let msg = `+${formatNumber(reward)} ü™ô`;
            if (gotGem) {
                gameState.gems += gemCount;
                msg += ` +${gemCount} üíé`;
            }
            
            const names = { common: '–û–±—ã—á–Ω—ã–π', rare: '–†–µ–¥–∫–∏–π', epic: '–≠–ø–∏—á–µ—Å–∫–∏–π', legendary: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π' };
            const emojis = { common: 'üì¶', rare: 'üéÅ', epic: 'üíú', legendary: 'üëë' };
            
            showModal(`${emojis[type]} ${names[type]} –∫–µ–π—Å`, msg, gotGem ? 'üíé' : 'ü™ô');
            hapticFeedback('success');
            
            addXP(type === 'legendary' ? 100 : type === 'epic' ? 50 : type === 'rare' ? 25 : 10);
            updateAllUI();
        }

        // ============ ACHIEVEMENTS ============
        const ACHIEVEMENTS = [
            { id: 'first_coin', name: '–ü–µ—Ä–≤–∞—è –º–æ–Ω–µ—Ç–∞', icon: 'ü™ô', condition: s => s.stats.totalEarned >= 100 },
            { id: 'rich', name: '–ë–æ–≥–∞—á', icon: 'üí∞', condition: s => s.coins >= 10000 },
            { id: 'miner', name: '–®–∞—Ö—Ç—ë—Ä', icon: '‚õèÔ∏è', condition: s => s.stats.totalMined >= 100 },
            { id: 'gambler', name: '–ò–≥—Ä–æ–∫', icon: 'üéÆ', condition: s => s.stats.gamesPlayed >= 50 },
            { id: 'lucky', name: '–í–µ–∑—É–Ω—á–∏–∫', icon: 'üçÄ', condition: s => s.stats.casinoWins >= 25 },
            { id: 'veteran', name: '–í–µ—Ç–µ—Ä–∞–Ω', icon: 'üèÖ', condition: s => s.level >= 10 },
            { id: 'dedicated', name: '–ü—Ä–µ–¥–∞–Ω–Ω—ã–π', icon: 'üî•', condition: s => s.stats.dailyStreak >= 7 },
            { id: 'collector', name: '–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä', icon: 'üíé', condition: s => s.gems >= 50 }
        ];

        function updateAchievements() {
            const container = document.getElementById('achievementsList');
            container.innerHTML = '';
            
            ACHIEVEMENTS.forEach(ach => {
                const unlocked = ach.condition(gameState);
                const div = document.createElement('div');
                div.className = `bg-gray-800/50 rounded-xl p-3 text-center text-2xl ${unlocked ? '' : 'opacity-30 grayscale'}`;
                div.textContent = unlocked ? ach.icon : '‚ùì';
                div.title = ach.name;
                container.appendChild(div);
                
                if (unlocked && !gameState.achievements.includes(ach.id)) {
                    gameState.achievements.push(ach.id);
                    setTimeout(() => {
                        showToast(`üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ: ${ach.name}!`, 'success');
                    }, 500);
                }
            });
        }

        // ============ HAPTIC FEEDBACK ============
        function hapticFeedback(type = 'light') {
            if (window.Telegram?.WebApp?.HapticFeedback) {
                if (type === 'success') {
                    window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                } else if (type === 'error') {
                    window.Telegram.WebApp.HapticFeedback.notificationOccurred('error');
                } else {
                    window.Telegram.WebApp.HapticFeedback.impactOccurred(type);
                }
            }
        }

        // ============ ENERGY REGENERATION ============
        function startEnergyRegen() {
            setInterval(() => {
                if (gameState.energy < gameState.maxEnergy) {
                    gameState.energy = Math.min(gameState.energy + 1, gameState.maxEnergy);
                    gameState.lastEnergyRegen = Date.now();
                    updateAllUI();
                }
            }, 6000); // 1 energy per 6 seconds
        }

        // ============ PLAY TIME TRACKER ============
        function startPlayTimeTracker() {
            playTimeInterval = setInterval(() => {
                gameState.stats.playTimeMinutes++;
                saveGame();
            }, 60000); // Every minute
        }

        // ============ TELEGRAM INTEGRATION ============
        function initTelegram() {
            const tg = window.Telegram?.WebApp;
            
            if (tg) {
                tg.ready();
                tg.expand();
                
                const user = tg.initDataUnsafe?.user;
                if (user) {
                    document.getElementById('playerInitial').textContent = (user.first_name || 'G')[0].toUpperCase();
                    document.getElementById('playerName').textContent = user.first_name || '–ò–≥—Ä–æ–∫';
                    
                    // Use user-specific storage key
                    const userKey = `gemrush_${user.id}_v2`;
                    const userSave = localStorage.getItem(userKey);
                    if (userSave) {
                        try {
                            const parsed = JSON.parse(userSave);
                            gameState = { ...JSON.parse(JSON.stringify(DEFAULT_STATE)), ...parsed };
                            gameState.ores = { ...DEFAULT_STATE.ores, ...parsed.ores };
                            gameState.stats = { ...DEFAULT_STATE.stats, ...parsed.stats };
                            calculateOfflineProgress();
                            updateAllUI();
                        } catch (e) {}
                    }
                    
                    // Override save function
                    const originalSave = saveGame;
                    window.saveGame = function() {
                        originalSave();
                        localStorage.setItem(userKey, JSON.stringify(gameState));
                    };
                }
                
                tg.enableClosingConfirmation();
            }
        }

        // ============ INIT ============
        document.addEventListener('DOMContentLoaded', () => {
            loadGame();
            initTelegram();
            startEnergyRegen();
            startPlayTimeTracker();
            checkDailyBonus();
        });

        // Save on page hide
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                saveGame();
            }
        });

        window.addEventListener('beforeunload', saveGame);
    </script>
</body>
</html>
