<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>LoveMeet - –ó–Ω–∞–∫–æ–º—Å—Ç–≤–∞</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overscroll-behavior: none;
        }
        .card {
            transition: transform 0.3s ease;
        }
        .card.swiping-left {
            transform: translateX(-100%) rotate(-20deg);
            opacity: 0;
        }
        .card.swiping-right {
            transform: translateX(100%) rotate(20deg);
            opacity: 0;
        }
        .photo-dot {
            transition: all 0.3s ease;
        }
        .photo-dot.active {
            width: 24px;
            background: white;
        }
        .match-animation {
            animation: matchPop 0.5s ease;
        }
        @keyframes matchPop {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }
        .heart-float {
            animation: floatUp 1s ease forwards;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-100px) scale(1.5); opacity: 0; }
        }
        .tab-active {
            background: white;
            color: #764ba2;
        }
        .message-bubble {
            max-width: 80%;
        }
        input[type="file"] {
            display: none;
        }
        .photo-placeholder {
            border: 2px dashed #ccc;
            transition: all 0.3s ease;
        }
        .photo-placeholder:hover {
            border-color: #764ba2;
            background: rgba(118, 75, 162, 0.1);
        }
    </style>
</head>
<body class="pb-20">
    <div id="app" class="max-w-md mx-auto">
        <!-- Splash Screen -->
        <div id="splash" class="fixed inset-0 bg-gradient-to-br from-purple-600 to-pink-500 flex items-center justify-center z-50">
            <div class="text-center text-white">
                <div class="text-6xl mb-4">üíú</div>
                <h1 class="text-3xl font-bold mb-2">LoveMeet</h1>
                <p class="opacity-80">–ù–∞–π–¥–∏ —Å–≤–æ—é –ª—é–±–æ–≤—å</p>
            </div>
        </div>

        <!-- Profile Setup -->
        <div id="profileSetup" class="hidden min-h-screen p-4">
            <div class="bg-white rounded-3xl p-6 shadow-2xl">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">–°–æ–∑–¥–∞–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
                
                <!-- Photos -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-600 mb-3">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (1-3)</label>
                    <div class="grid grid-cols-3 gap-3">
                        <div class="photo-upload aspect-square rounded-xl photo-placeholder flex items-center justify-center cursor-pointer overflow-hidden" data-index="0">
                            <span class="text-4xl text-gray-400">+</span>
                        </div>
                        <div class="photo-upload aspect-square rounded-xl photo-placeholder flex items-center justify-center cursor-pointer overflow-hidden" data-index="1">
                            <span class="text-4xl text-gray-400">+</span>
                        </div>
                        <div class="photo-upload aspect-square rounded-xl photo-placeholder flex items-center justify-center cursor-pointer overflow-hidden" data-index="2">
                            <span class="text-4xl text-gray-400">+</span>
                        </div>
                    </div>
                    <input type="file" id="photoInput" accept="image/*">
                </div>

                <!-- Name -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-600 mb-2">–ò–º—è</label>
                    <input type="text" id="nameInput" placeholder="–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?" 
                        class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 outline-none transition">
                </div>

                <!-- Age -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-600 mb-2">–í–æ–∑—Ä–∞—Å—Ç</label>
                    <input type="number" id="ageInput" placeholder="–°–∫–æ–ª—å–∫–æ —Ç–µ–±–µ –ª–µ—Ç?" min="18" max="100"
                        class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 outline-none transition">
                </div>

                <!-- Gender -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-600 mb-2">–ü–æ–ª</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button type="button" class="gender-btn px-4 py-3 rounded-xl border-2 border-gray-200 font-medium transition" data-gender="male">
                            üë® –ú—É–∂—Å–∫–æ–π
                        </button>
                        <button type="button" class="gender-btn px-4 py-3 rounded-xl border-2 border-gray-200 font-medium transition" data-gender="female">
                            üë© –ñ–µ–Ω—Å–∫–∏–π
                        </button>
                    </div>
                </div>

                <!-- Looking for -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-600 mb-2">–ò—â—É</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button type="button" class="looking-btn px-4 py-3 rounded-xl border-2 border-gray-200 font-medium transition" data-looking="male">
                            üë® –ú—É–∂—á–∏–Ω
                        </button>
                        <button type="button" class="looking-btn px-4 py-3 rounded-xl border-2 border-gray-200 font-medium transition" data-looking="female">
                            üë© –ñ–µ–Ω—â–∏–Ω
                        </button>
                    </div>
                </div>

                <!-- Description -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-600 mb-2">–û —Å–µ–±–µ</label>
                    <textarea id="bioInput" placeholder="–†–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ..." rows="3"
                        class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-purple-500 focus:ring-2 focus:ring-purple-200 outline-none transition resize-none"></textarea>
                </div>

                <!-- Save Button -->
                <button id="saveProfile" class="w-full py-4 bg-gradient-to-r from-purple-600 to-pink-500 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transition transform hover:scale-[1.02]">
                    –ù–∞—á–∞—Ç—å –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞ üíú
                </button>
            </div>
        </div>

        <!-- Main App -->
        <div id="mainApp" class="hidden">
            <!-- Header -->
            <div class="bg-white/10 backdrop-blur-lg p-4 flex items-center justify-between">
                <h1 class="text-xl font-bold text-white">üíú LoveMeet</h1>
                <button id="editProfileBtn" class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
                    <span class="text-white">‚öôÔ∏è</span>
                </button>
            </div>

            <!-- Cards Section -->
            <div id="cardsSection" class="p-4">
                <div id="cardStack" class="relative h-[500px]">
                    <!-- Cards will be inserted here -->
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-center gap-6 mt-6">
                    <button id="dislikeBtn" class="w-16 h-16 bg-white rounded-full shadow-lg flex items-center justify-center text-3xl hover:scale-110 transition transform">
                        ‚ùå
                    </button>
                    <button id="superlikeBtn" class="w-14 h-14 bg-blue-500 rounded-full shadow-lg flex items-center justify-center text-2xl hover:scale-110 transition transform">
                        ‚≠ê
                    </button>
                    <button id="likeBtn" class="w-16 h-16 bg-gradient-to-r from-pink-500 to-red-500 rounded-full shadow-lg flex items-center justify-center text-3xl hover:scale-110 transition transform">
                        ‚ù§Ô∏è
                    </button>
                </div>

                <!-- No More Cards -->
                <div id="noCards" class="hidden text-center py-20">
                    <div class="text-6xl mb-4">üòî</div>
                    <h3 class="text-xl font-semibold text-white mb-2">–ê–Ω–∫–µ—Ç—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å</h3>
                    <p class="text-white/70">–ó–∞–≥–ª—è–Ω–∏ –ø–æ–∑–∂–µ, –ø–æ—è–≤—è—Ç—Å—è –Ω–æ–≤—ã–µ –ª—é–¥–∏!</p>
                </div>
            </div>

            <!-- Matches Section -->
            <div id="matchesSection" class="hidden p-4">
                <h2 class="text-xl font-bold text-white mb-4">–í–∑–∞–∏–º–Ω—ã–µ —Å–∏–º–ø–∞—Ç–∏–∏</h2>
                <div id="matchesList" class="space-y-3">
                    <!-- Matches will be inserted here -->
                </div>
                <div id="noMatches" class="hidden text-center py-20">
                    <div class="text-6xl mb-4">üí´</div>
                    <h3 class="text-xl font-semibold text-white mb-2">–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π</h3>
                    <p class="text-white/70">–ü—Ä–æ–¥–æ–ª–∂–∞–π –ª–∏—Å—Ç–∞—Ç—å –∞–Ω–∫–µ—Ç—ã!</p>
                </div>
            </div>

            <!-- Chat Section -->
            <div id="chatSection" class="hidden fixed inset-0 bg-white z-40">
                <div class="bg-gradient-to-r from-purple-600 to-pink-500 p-4 flex items-center gap-3">
                    <button id="backFromChat" class="text-white text-2xl">‚Üê</button>
                    <img id="chatAvatar" class="w-10 h-10 rounded-full object-cover" src="" alt="">
                    <span id="chatName" class="text-white font-semibold"></span>
                </div>
                <div id="chatMessages" class="h-[calc(100vh-140px)] overflow-y-auto p-4 space-y-3 bg-gray-50">
                    <!-- Messages will be inserted here -->
                </div>
                <div class="absolute bottom-0 left-0 right-0 p-4 bg-white border-t">
                    <div class="flex gap-2">
                        <input type="text" id="messageInput" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                            class="flex-1 px-4 py-3 rounded-full border border-gray-200 focus:border-purple-500 outline-none">
                        <button id="sendMessage" class="w-12 h-12 bg-gradient-to-r from-purple-600 to-pink-500 rounded-full flex items-center justify-center text-white">
                            ‚û§
                        </button>
                    </div>
                </div>
            </div>

            <!-- Profile View Section -->
            <div id="myProfileSection" class="hidden p-4">
                <div class="bg-white rounded-3xl p-6 shadow-xl">
                    <div id="myProfileContent">
                        <!-- Profile content will be inserted here -->
                    </div>
                    <button id="editMyProfile" class="w-full mt-4 py-3 bg-gradient-to-r from-purple-600 to-pink-500 text-white font-semibold rounded-xl">
                        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                    </button>
                </div>
            </div>
        </div>

        <!-- Match Popup -->
        <div id="matchPopup" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
            <div class="match-animation bg-white rounded-3xl p-8 text-center max-w-sm w-full">
                <div class="text-6xl mb-4">üéâ</div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">–≠—Ç–æ –≤–∑–∞–∏–º–Ω–æ!</h2>
                <p class="text-gray-600 mb-4">–í—ã –ø–æ–Ω—Ä–∞–≤–∏–ª–∏—Å—å –¥—Ä—É–≥ –¥—Ä—É–≥—É</p>
                <div class="flex justify-center gap-4 mb-6">
                    <img id="matchMyPhoto" class="w-20 h-20 rounded-full object-cover border-4 border-pink-500" src="" alt="">
                    <div class="text-4xl self-center">‚ù§Ô∏è</div>
                    <img id="matchTheirPhoto" class="w-20 h-20 rounded-full object-cover border-4 border-purple-500" src="" alt="">
                </div>
                <button id="sendMessageMatch" class="w-full py-3 bg-gradient-to-r from-purple-600 to-pink-500 text-white font-semibold rounded-xl mb-3">
                    –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
                </button>
                <button id="continueSwipe" class="w-full py-3 border-2 border-gray-200 text-gray-600 font-semibold rounded-xl">
                    –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä
                </button>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div id="bottomNav" class="hidden fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-lg border-t border-gray-100 z-30">
            <div class="max-w-md mx-auto flex">
                <button class="nav-tab flex-1 py-4 flex flex-col items-center gap-1 tab-active" data-tab="cards">
                    <span class="text-xl">üî•</span>
                    <span class="text-xs font-medium">–ü–æ–∏—Å–∫</span>
                </button>
                <button class="nav-tab flex-1 py-4 flex flex-col items-center gap-1" data-tab="matches">
                    <span class="text-xl">üí¨</span>
                    <span class="text-xs font-medium">–ß–∞—Ç—ã</span>
                    <span id="matchBadge" class="hidden absolute -mt-2 ml-6 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">0</span>
                </button>
                <button class="nav-tab flex-1 py-4 flex flex-col items-center gap-1" data-tab="profile">
                    <span class="text-xl">üë§</span>
                    <span class="text-xs font-medium">–ü—Ä–æ—Ñ–∏–ª—å</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // FIREBASE CONFIGURATION
        // =============================================
        // –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ –∏–∑ Firebase Console!
        // 1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ https://console.firebase.google.com/
        // 2. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç
        // 3. –î–æ–±–∞–≤—å—Ç–µ Web App
        // 4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é —Å—é–¥–∞
        // 5. –í–∫–ª—é—á–∏—Ç–µ Firestore Database –∏ Storage
        // =============================================
        
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        let db, storage;
        let firebaseEnabled = false;
        
        try {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                storage = firebase.storage();
                firebaseEnabled = true;
                console.log('‚úÖ Firebase –ø–æ–¥–∫–ª—é—á–µ–Ω');
            } else {
                console.log('‚ö†Ô∏è Firebase –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω - —Ä–∞–±–æ—Ç–∞–µ–º –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ');
            }
        } catch (e) {
            console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ Firebase:', e);
        }

        // Initialize Telegram WebApp
        const tg = window.Telegram?.WebApp;
        let tgUser = null;
        
        if (tg) {
            tg.ready();
            tg.expand();
            tgUser = tg.initDataUnsafe?.user;
        }

        // Generate unique user ID
        function getUserId() {
            if (tgUser?.id) return 'tg_' + tgUser.id;
            let id = localStorage.getItem('lovemeet_device_id');
            if (!id) {
                id = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('lovemeet_device_id', id);
            }
            return id;
        }

        // App State
        let state = {
            userId: getUserId(),
            currentUser: null,
            users: [],
            matches: [],
            messages: {},
            swipedUsers: [],
            currentPhotoIndex: 0,
            editingPhotoIndex: 0,
            tempPhotos: [null, null, null],
            currentChatUser: null,
            unsubscribeMessages: null
        };

        // Demo Users (used when Firebase is not configured)
        const demoUsers = [
            {
                id: 'demo_1',
                name: "–ê–Ω–Ω–∞",
                age: 24,
                gender: "female",
                looking: "male",
                bio: "–õ—é–±–ª—é –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è –∏ —Ö–æ—Ä–æ—à—É—é –º—É–∑—ã–∫—É üéµ",
                photos: ["https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=400&h=500&fit=crop"]
            },
            {
                id: 'demo_2',
                name: "–ú–∏—Ö–∞–∏–ª",
                age: 28,
                gender: "male",
                looking: "female",
                bio: "–ü—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç, –ª—é–±–ª—é —Å–ø–æ—Ä—Ç ‚òï",
                photos: ["https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=400&h=500&fit=crop"]
            },
            {
                id: 'demo_3',
                name: "–ï–∫–∞—Ç–µ—Ä–∏–Ω–∞",
                age: 26,
                gender: "female",
                looking: "male",
                bio: "–î–∏–∑–∞–π–Ω–µ—Ä, –æ–±–æ–∂–∞—é –∏—Å–∫—É—Å—Å—Ç–≤–æ üé®",
                photos: ["https://images.unsplash.com/photo-1534528741775-53994a69daeb?w=400&h=500&fit=crop"]
            },
            {
                id: 'demo_4',
                name: "–ê–ª–µ–∫—Å–∞–Ω–¥—Ä",
                age: 30,
                gender: "male",
                looking: "female",
                bio: "–ü—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å üåç",
                photos: ["https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=500&fit=crop"]
            },
            {
                id: 'demo_5',
                name: "–ú–∞—Ä–∏—è",
                age: 23,
                gender: "female",
                looking: "male",
                bio: "–°—Ç—É–¥–µ–Ω—Ç–∫–∞, –π–æ–≥–∞ üßò‚Äç‚ôÄÔ∏è",
                photos: ["https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=400&h=500&fit=crop"]
            }
        ];

        // =============================================
        // FIREBASE FUNCTIONS
        // =============================================

        // Upload photo to Firebase Storage
        async function uploadPhoto(dataUrl, index) {
            if (!firebaseEnabled) return dataUrl;
            
            showLoading('–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ...');
            try {
                const response = await fetch(dataUrl);
                const blob = await response.blob();
                const ref = storage.ref(`photos/${state.userId}/photo_${index}_${Date.now()}.jpg`);
                await ref.put(blob);
                const url = await ref.getDownloadURL();
                hideLoading();
                return url;
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ:', e);
                hideLoading();
                return dataUrl;
            }
        }

        // Save user profile to Firestore
        async function saveUserToFirebase(userData) {
            if (!firebaseEnabled) return;
            
            try {
                await db.collection('users').doc(state.userId).set({
                    ...userData,
                    oderId: state.userId,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                console.log('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:', e);
            }
        }

        // Load users from Firestore
        async function loadUsersFromFirebase() {
            if (!firebaseEnabled) {
                state.users = demoUsers.filter(u => 
                    u.gender === state.currentUser?.looking && 
                    u.looking === state.currentUser?.gender
                );
                return;
            }
            
            showLoading('–ü–æ–∏—Å–∫ –ª—é–¥–µ–π...');
            try {
                const snapshot = await db.collection('users')
                    .where('gender', '==', state.currentUser.looking)
                    .where('looking', '==', state.currentUser.gender)
                    .limit(50)
                    .get();
                
                state.users = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.userId !== state.userId && !state.swipedUsers.includes(data.userId)) {
                        state.users.push({ id: doc.id, oderId: data.userId, ...data });
                    }
                });
                
                console.log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ ${state.users.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π`);
                hideLoading();
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', e);
                hideLoading();
            }
        }

        // Record a swipe (like/dislike)
        async function recordSwipe(targetUserId, isLike) {
            state.swipedUsers.push(targetUserId);
            localStorage.setItem('lovemeet_swiped', JSON.stringify(state.swipedUsers));
            
            if (!firebaseEnabled) {
                // Demo mode: random match
                if (isLike && Math.random() > 0.5) {
                    const user = state.users.find(u => u.oderId === targetUserId || u.id === targetUserId);
                    if (user) {
                        state.matches.push(user);
                        showMatchPopup(user);
                    }
                }
                return;
            }
            
            if (!isLike) return;
            
            try {
                // Save like
                await db.collection('likes').add({
                    fromUserId: state.userId,
                    toUserId: targetUserId,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Check if mutual like exists
                const mutual = await db.collection('likes')
                    .where('fromUserId', '==', targetUserId)
                    .where('toUserId', '==', state.userId)
                    .get();
                
                if (!mutual.empty) {
                    // Create match!
                    const matchId = [state.userId, targetUserId].sort().join('_');
                    await db.collection('matches').doc(matchId).set({
                        users: [state.userId, targetUserId],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    const user = state.users.find(u => u.oderId === targetUserId);
                    if (user) {
                        state.matches.push(user);
                        showMatchPopup(user);
                        saveState();
                    }
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –ª–∞–π–∫–∞:', e);
            }
        }

        // Load matches from Firestore
        async function loadMatchesFromFirebase() {
            if (!firebaseEnabled) return;
            
            try {
                const snapshot = await db.collection('matches')
                    .where('users', 'array-contains', state.userId)
                    .get();
                
                const matchUserIds = [];
                snapshot.forEach(doc => {
                    const users = doc.data().users;
                    const otherId = users.find(id => id !== state.userId);
                    if (otherId) matchUserIds.push(otherId);
                });
                
                // Load matched user profiles
                for (const oderId of matchUserIds) {
                    if (!state.matches.find(m => m.oderId === oderId)) {
                        const userDoc = await db.collection('users').where('oderId', '==', oderId).limit(1).get();
                        if (!userDoc.empty) {
                            state.matches.push({ id: userDoc.docs[0].id, ...userDoc.docs[0].data() });
                        }
                    }
                }
                
                updateMatchBadge();
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ç—á–µ–π:', e);
            }
        }

        // Send message via Firebase
        async function sendMessageToFirebase(toUserId, text) {
            if (!firebaseEnabled) return;
            
            const chatId = [state.userId, toUserId].sort().join('_');
            
            try {
                await db.collection('chats').doc(chatId).collection('messages').add({
                    senderId: state.userId,
                    text: text,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', e);
            }
        }

        // Subscribe to chat messages
        function subscribeToMessages(toUserId) {
            if (!firebaseEnabled) return;
            
            if (state.unsubscribeMessages) {
                state.unsubscribeMessages();
            }
            
            const chatId = [state.userId, toUserId].sort().join('_');
            
            state.unsubscribeMessages = db.collection('chats').doc(chatId)
                .collection('messages')
                .orderBy('createdAt', 'asc')
                .onSnapshot(snapshot => {
                    const messages = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        messages.push({
                            text: data.text,
                            fromMe: data.senderId === state.userId,
                            timestamp: data.createdAt?.toMillis() || Date.now()
                        });
                    });
                    state.messages[toUserId] = messages;
                    if (state.currentChatUser?.userId === toUserId || state.currentChatUser?.id === toUserId) {
                        renderMessages();
                    }
                });
        }

        // =============================================
        // UI FUNCTIONS
        // =============================================

        function showLoading(text = '–ó–∞–≥—Ä—É–∑–∫–∞...') {
            let loader = document.getElementById('loader');
            if (!loader) {
                loader = document.createElement('div');
                loader.id = 'loader';
                loader.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-[100]';
                loader.innerHTML = `
                    <div class="bg-white rounded-2xl p-6 text-center">
                        <div class="animate-spin text-4xl mb-2">üíú</div>
                        <p class="text-gray-600" id="loaderText">${text}</p>
                    </div>
                `;
                document.body.appendChild(loader);
            } else {
                document.getElementById('loaderText').textContent = text;
                loader.classList.remove('hidden');
            }
        }

        function hideLoading() {
            const loader = document.getElementById('loader');
            if (loader) loader.classList.add('hidden');
        }

        // Load local state
        function loadState() {
            const saved = localStorage.getItem('lovemeet_state_v2');
            if (saved) {
                const parsed = JSON.parse(saved);
                state = { ...state, ...parsed, userId: state.userId };
            }
            
            const swiped = localStorage.getItem('lovemeet_swiped');
            if (swiped) {
                state.swipedUsers = JSON.parse(swiped);
            }
        }

        // Save local state
        function saveState() {
            const toSave = {
                currentUser: state.currentUser,
                matches: state.matches,
                messages: state.messages
            };
            localStorage.setItem('lovemeet_state_v2', JSON.stringify(toSave));
        }

        // Initialize App
        async function init() {
            loadState();
            
            setTimeout(async () => {
                document.getElementById('splash').classList.add('hidden');
                
                if (state.currentUser) {
                    await showMainApp();
                } else {
                    showProfileSetup();
                }
            }, 1500);

            setupEventListeners();
        }

        // Show Profile Setup
        function showProfileSetup(editing = false) {
            document.getElementById('profileSetup').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('bottomNav').classList.add('hidden');

            if (editing && state.currentUser) {
                document.getElementById('nameInput').value = state.currentUser.name;
                document.getElementById('ageInput').value = state.currentUser.age;
                document.getElementById('bioInput').value = state.currentUser.bio || '';
                state.tempPhotos = [...(state.currentUser.photos || []), null, null, null].slice(0, 3);
                
                document.querySelectorAll('.gender-btn').forEach(btn => {
                    btn.classList.remove('border-purple-500', 'bg-purple-50');
                    if (btn.dataset.gender === state.currentUser.gender) {
                        btn.classList.add('border-purple-500', 'bg-purple-50');
                    }
                });
                
                document.querySelectorAll('.looking-btn').forEach(btn => {
                    btn.classList.remove('border-purple-500', 'bg-purple-50');
                    if (btn.dataset.looking === state.currentUser.looking) {
                        btn.classList.add('border-purple-500', 'bg-purple-50');
                    }
                });
                
                updatePhotoPreview();
            } else {
                state.tempPhotos = [null, null, null];
            }
        }

        // Show Main App
        async function showMainApp() {
            document.getElementById('profileSetup').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('bottomNav').classList.remove('hidden');
            
            await loadUsersFromFirebase();
            await loadMatchesFromFirebase();
            renderCards();
            updateMatchBadge();
        }

        // Render Cards
        function renderCards() {
            const stack = document.getElementById('cardStack');
            const noCards = document.getElementById('noCards');
            
            stack.innerHTML = '';
            
            // Filter out already swiped users
            const availableUsers = state.users.filter(u => 
                !state.swipedUsers.includes(u.userId) && !state.swipedUsers.includes(u.id)
            );
            
            if (availableUsers.length === 0) {
                noCards.classList.remove('hidden');
                return;
            }
            
            noCards.classList.add('hidden');
            
            const cardsToShow = availableUsers.slice(0, 3).reverse();
            
            cardsToShow.forEach((user, index) => {
                const card = createCard(user, index === cardsToShow.length - 1);
                stack.appendChild(card);
            });
        }

        // Create Card Element
        function createCard(user, isTop) {
            const card = document.createElement('div');
            card.className = `card absolute inset-0 bg-white rounded-3xl shadow-2xl overflow-hidden ${isTop ? 'z-10' : ''}`;
            card.dataset.userId = user.userId || user.id;
            
            const photos = user.photos || [];
            const photoHtml = photos.map((photo, idx) => `
                <img src="${photo}" class="absolute inset-0 w-full h-full object-cover transition-opacity duration-300 ${idx === 0 ? 'opacity-100' : 'opacity-0'}" data-photo-idx="${idx}">
            `).join('');
            
            const dotsHtml = photos.length > 1 ? photos.map((_, idx) => `
                <div class="photo-dot w-2 h-2 rounded-full bg-white/50 ${idx === 0 ? 'active' : ''}" data-dot-idx="${idx}"></div>
            `).join('') : '';
            
            card.innerHTML = `
                <div class="relative h-full">
                    ${photoHtml}
                    <div class="absolute top-4 left-0 right-0 flex justify-center gap-1">
                        ${dotsHtml}
                    </div>
                    <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-transparent to-transparent"></div>
                    <div class="absolute bottom-0 left-0 right-0 p-6 text-white">
                        <h3 class="text-2xl font-bold">${user.name}, ${user.age}</h3>
                        <p class="text-white/80 mt-2 line-clamp-2">${user.bio || ''}</p>
                    </div>
                    <div class="absolute top-1/2 left-4 transform -translate-y-1/2 text-5xl font-bold text-green-500 opacity-0 like-indicator rotate-[-20deg]">LIKE</div>
                    <div class="absolute top-1/2 right-4 transform -translate-y-1/2 text-5xl font-bold text-red-500 opacity-0 nope-indicator rotate-[20deg]">NOPE</div>
                </div>
            `;
            
            if (isTop && photos.length > 1) {
                card.addEventListener('click', (e) => {
                    if (e.target.closest('.like-indicator') || e.target.closest('.nope-indicator')) return;
                    
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const width = rect.width;
                    
                    const photoEls = card.querySelectorAll('[data-photo-idx]');
                    const dots = card.querySelectorAll('[data-dot-idx]');
                    let currentIdx = Array.from(photoEls).findIndex(p => p.classList.contains('opacity-100'));
                    
                    if (x < width / 2) {
                        currentIdx = Math.max(0, currentIdx - 1);
                    } else {
                        currentIdx = Math.min(photoEls.length - 1, currentIdx + 1);
                    }
                    
                    photoEls.forEach((p, i) => {
                        p.classList.toggle('opacity-100', i === currentIdx);
                        p.classList.toggle('opacity-0', i !== currentIdx);
                    });
                    
                    dots.forEach((d, i) => {
                        d.classList.toggle('active', i === currentIdx);
                    });
                });
            }
            
            return card;
        }

        // Swipe Card
        async function swipeCard(direction) {
            const stack = document.getElementById('cardStack');
            const topCard = stack.querySelector('.card.z-10');
            
            if (!topCard) return;
            
            const oderId = topCard.dataset.userId;
            
            topCard.classList.add(direction === 'right' ? 'swiping-right' : 'swiping-left');
            
            await recordSwipe(oderId, direction === 'right');
            
            setTimeout(() => {
                renderCards();
                saveState();
            }, 300);
        }

        // Show Match Popup
        function showMatchPopup(user) {
            const popup = document.getElementById('matchPopup');
            document.getElementById('matchMyPhoto').src = state.currentUser.photos[0];
            document.getElementById('matchTheirPhoto').src = user.photos?.[0] || '';
            popup.classList.remove('hidden');
            state.currentChatUser = user;
            updateMatchBadge();
        }

        // Render Matches
        function renderMatches() {
            const list = document.getElementById('matchesList');
            const noMatches = document.getElementById('noMatches');
            
            if (state.matches.length === 0) {
                list.innerHTML = '';
                noMatches.classList.remove('hidden');
                return;
            }
            
            noMatches.classList.add('hidden');
            
            list.innerHTML = state.matches.map(match => {
                const oderId = match.oderId || match.id;
                const lastMsg = state.messages[oderId]?.slice(-1)[0]?.text || '–ù–æ–≤–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ! üëã';
                return `
                    <div class="match-item bg-white rounded-2xl p-4 flex items-center gap-4 cursor-pointer hover:shadow-lg transition" data-match-id="${oderId}">
                        <img src="${match.photos?.[0] || ''}" class="w-14 h-14 rounded-full object-cover">
                        <div class="flex-1 min-w-0">
                            <h4 class="font-semibold text-gray-800">${match.name}, ${match.age}</h4>
                            <p class="text-sm text-gray-500 truncate">${lastMsg}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Open Chat
        function openChat(oderId) {
            const user = state.matches.find(m => (m.oderId || m.id) === oderId);
            if (!user) return;
            
            state.currentChatUser = user;
            
            document.getElementById('chatAvatar').src = user.photos?.[0] || '';
            document.getElementById('chatName').textContent = `${user.name}, ${user.age}`;
            document.getElementById('chatSection').classList.remove('hidden');
            
            subscribeToMessages(user.oderId || user.id);
            renderMessages();
        }

        // Render Messages
        function renderMessages() {
            const container = document.getElementById('chatMessages');
            const oderId = state.currentChatUser?.oderId || state.currentChatUser?.id;
            const messages = state.messages[oderId] || [];
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-10">
                        <div class="text-4xl mb-2">üëã</div>
                        <p class="text-gray-500">–ù–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = messages.map(msg => `
                <div class="flex ${msg.fromMe ? 'justify-end' : 'justify-start'}">
                    <div class="message-bubble px-4 py-2 rounded-2xl ${msg.fromMe ? 'bg-gradient-to-r from-purple-600 to-pink-500 text-white' : 'bg-gray-200 text-gray-800'}">
                        ${msg.text}
                    </div>
                </div>
            `).join('');
            
            container.scrollTop = container.scrollHeight;
        }

        // Send Message
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text || !state.currentChatUser) return;
            
            const oderId = state.currentChatUser.oderId || state.currentChatUser.id;
            
            if (!state.messages[oderId]) {
                state.messages[oderId] = [];
            }
            
            // Add message locally
            state.messages[oderId].push({
                text,
                fromMe: true,
                timestamp: Date.now()
            });
            
            input.value = '';
            renderMessages();
            
            // Send to Firebase
            await sendMessageToFirebase(oderId, text);
            
            // Demo mode: simulate reply
            if (!firebaseEnabled) {
                setTimeout(() => {
                    const replies = ["–ü—Ä–∏–≤–µ—Ç! üòä", "–ö–∞–∫ –¥–µ–ª–∞?", "–†–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ üôÇ", "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ! üòä‚ù§Ô∏è"];
                    state.messages[oderId].push({
                        text: replies[Math.floor(Math.random() * replies.length)],
                        fromMe: false,
                        timestamp: Date.now()
                    });
                    renderMessages();
                }, 1500);
            }
            
            saveState();
        }

        // Update Match Badge
        function updateMatchBadge() {
            const badge = document.getElementById('matchBadge');
            if (state.matches.length > 0) {
                badge.textContent = state.matches.length;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        // Update Photo Preview
        function updatePhotoPreview() {
            document.querySelectorAll('.photo-upload').forEach((el, idx) => {
                if (state.tempPhotos[idx]) {
                    el.innerHTML = `<img src="${state.tempPhotos[idx]}" class="w-full h-full object-cover">`;
                } else {
                    el.innerHTML = '<span class="text-4xl text-gray-400">+</span>';
                }
            });
        }

        // Render My Profile
        function renderMyProfile() {
            const container = document.getElementById('myProfileContent');
            if (!state.currentUser) return;
            
            const photosHtml = (state.currentUser.photos || []).map(photo => 
                `<img src="${photo}" class="w-full aspect-square rounded-xl object-cover">`
            ).join('');
            
            const modeText = firebaseEnabled ? 'üü¢ –û–Ω–ª–∞–π–Ω —Ä–µ–∂–∏–º' : 'üü° –î–µ–º–æ —Ä–µ–∂–∏–º';
            
            container.innerHTML = `
                <div class="text-center text-xs text-gray-400 mb-4">${modeText}</div>
                <div class="flex justify-center mb-4">
                    <img src="${state.currentUser.photos?.[0] || ''}" class="w-32 h-32 rounded-full object-cover border-4 border-purple-500">
                </div>
                <h3 class="text-xl font-bold text-center text-gray-800">${state.currentUser.name}, ${state.currentUser.age}</h3>
                <p class="text-center text-gray-600 mt-2">${state.currentUser.bio || ''}</p>
                <div class="grid grid-cols-3 gap-2 mt-4">${photosHtml}</div>
            `;
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Gender buttons
            document.querySelectorAll('.gender-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.gender-btn').forEach(b => {
                        b.classList.remove('border-purple-500', 'bg-purple-50');
                    });
                    btn.classList.add('border-purple-500', 'bg-purple-50');
                });
            });

            // Looking for buttons
            document.querySelectorAll('.looking-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.looking-btn').forEach(b => {
                        b.classList.remove('border-purple-500', 'bg-purple-50');
                    });
                    btn.classList.add('border-purple-500', 'bg-purple-50');
                });
            });

            // Photo upload
            document.querySelectorAll('.photo-upload').forEach(el => {
                el.addEventListener('click', () => {
                    state.editingPhotoIndex = parseInt(el.dataset.index);
                    document.getElementById('photoInput').click();
                });
            });

            document.getElementById('photoInput').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) {
                        alert('–§–æ—Ç–æ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ. –ú–∞–∫—Å–∏–º—É–º 5 –ú–ë');
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        state.tempPhotos[state.editingPhotoIndex] = e.target.result;
                        updatePhotoPreview();
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Save Profile
            document.getElementById('saveProfile').addEventListener('click', async () => {
                const name = document.getElementById('nameInput').value.trim();
                const age = parseInt(document.getElementById('ageInput').value);
                const bio = document.getElementById('bioInput').value.trim();
                const gender = document.querySelector('.gender-btn.border-purple-500')?.dataset.gender;
                const looking = document.querySelector('.looking-btn.border-purple-500')?.dataset.looking;
                const photos = state.tempPhotos.filter(p => p !== null);

                if (!name || !age || !gender || !looking || photos.length === 0) {
                    alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –∏ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ');
                    return;
                }

                if (age < 18) {
                    alert('–í–∞–º –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 18+');
                    return;
                }

                showLoading('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è...');
                
                // Upload photos to Firebase Storage
                const uploadedPhotos = [];
                for (let i = 0; i < photos.length; i++) {
                    const url = await uploadPhoto(photos[i], i);
                    uploadedPhotos.push(url);
                }

                state.currentUser = {
                    oderId: state.userId,
                    name,
                    age,
                    bio,
                    gender,
                    looking,
                    photos: uploadedPhotos
                };

                await saveUserToFirebase(state.currentUser);
                saveState();
                hideLoading();
                await showMainApp();
            });

            // Action Buttons
            document.getElementById('likeBtn').addEventListener('click', () => swipeCard('right'));
            document.getElementById('dislikeBtn').addEventListener('click', () => swipeCard('left'));
            document.getElementById('superlikeBtn').addEventListener('click', () => swipeCard('right'));

            // Navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', async () => {
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('tab-active'));
                    tab.classList.add('tab-active');

                    const tabName = tab.dataset.tab;
                    
                    document.getElementById('cardsSection').classList.add('hidden');
                    document.getElementById('matchesSection').classList.add('hidden');
                    document.getElementById('myProfileSection').classList.add('hidden');

                    if (tabName === 'cards') {
                        document.getElementById('cardsSection').classList.remove('hidden');
                    } else if (tabName === 'matches') {
                        document.getElementById('matchesSection').classList.remove('hidden');
                        await loadMatchesFromFirebase();
                        renderMatches();
                    } else if (tabName === 'profile') {
                        document.getElementById('myProfileSection').classList.remove('hidden');
                        renderMyProfile();
                    }
                });
            });

            // Match item click
            document.getElementById('matchesList').addEventListener('click', (e) => {
                const matchItem = e.target.closest('.match-item');
                if (matchItem) {
                    openChat(matchItem.dataset.matchId);
                }
            });

            // Chat
            document.getElementById('backFromChat').addEventListener('click', () => {
                document.getElementById('chatSection').classList.add('hidden');
                if (state.unsubscribeMessages) {
                    state.unsubscribeMessages();
                }
            });

            document.getElementById('sendMessage').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            // Match Popup
            document.getElementById('continueSwipe').addEventListener('click', () => {
                document.getElementById('matchPopup').classList.add('hidden');
            });

            document.getElementById('sendMessageMatch').addEventListener('click', () => {
                document.getElementById('matchPopup').classList.add('hidden');
                openChat(state.currentChatUser.oderId || state.currentChatUser.id);
            });

            // Edit Profile
            document.getElementById('editProfileBtn').addEventListener('click', () => {
                showProfileSetup(true);
            });

            document.getElementById('editMyProfile').addEventListener('click', () => {
                showProfileSetup(true);
            });

            // Touch swipe on cards
            let startX = 0;
            let currentX = 0;
            let isDragging = false;

            document.getElementById('cardStack').addEventListener('touchstart', (e) => {
                const card = e.target.closest('.card.z-10');
                if (!card) return;
                startX = e.touches[0].clientX;
                isDragging = true;
            });

            document.getElementById('cardStack').addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                currentX = e.touches[0].clientX;
                const diff = currentX - startX;
                const card = document.querySelector('.card.z-10');
                
                if (card) {
                    card.style.transform = `translateX(${diff}px) rotate(${diff * 0.05}deg)`;
                    const likeIndicator = card.querySelector('.like-indicator');
                    const nopeIndicator = card.querySelector('.nope-indicator');
                    
                    if (diff > 50) {
                        likeIndicator.style.opacity = Math.min(1, (diff - 50) / 100);
                        nopeIndicator.style.opacity = 0;
                    } else if (diff < -50) {
                        nopeIndicator.style.opacity = Math.min(1, (-diff - 50) / 100);
                        likeIndicator.style.opacity = 0;
                    } else {
                        likeIndicator.style.opacity = 0;
                        nopeIndicator.style.opacity = 0;
                    }
                }
            });

            document.getElementById('cardStack').addEventListener('touchend', () => {
                if (!isDragging) return;
                isDragging = false;
                
                const diff = currentX - startX;
                const card = document.querySelector('.card.z-10');
                
                if (Math.abs(diff) > 100) {
                    swipeCard(diff > 0 ? 'right' : 'left');
                } else if (card) {
                    card.style.transform = '';
                    card.querySelector('.like-indicator').style.opacity = 0;
                    card.querySelector('.nope-indicator').style.opacity = 0;
                }
                
                startX = 0;
                currentX = 0;
            });
        }

        // Initialize
        init();
    </script>
</body>
</html>
